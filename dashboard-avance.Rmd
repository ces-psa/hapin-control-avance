---
title: "Control avance HAPIN"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# load use packages
library(package = "tidyverse")
library(package = "crosstalk")

# Load helper functions
source(file = "scripts/zz_output.R")
```



```{r get-uvg-data}
# Participant information (z10)
source(file = "scripts/0_get_participants.R", encoding = "UTF-8")

# Pre-screening information (s0)
source(file = "scripts/0_get_prescreening.R", encoding = "UTF-8")

# Exposure supporting data (h41 start)
source(file = "scripts/0_get_exposure_start.R", encoding = "UTF-8")
```




```{r get_data}
# Emory RedCap dictionary
source(file = "scripts/0_get_emory_dictionary.R", encoding = "UTF-8")

# Emory RedCap export data
source(file = "scripts/0_get_emory_data.R", encoding = "UTF-8")
```




```{r, include=FALSE}
gt_emory_data %>%
  select(id, s1_ultra, matches("m17.+(fl|crl|hc)"), s4_main_id) %>%
  filter(s1_ultra == 1) %>%
  print(n = Inf)
```




```{r prepare-women-data}
#------------------------------------------------------------------------------*
# Separate data topics ----
#------------------------------------------------------------------------------*

# Mujeres tamizadas elegibles pero no inscritas
elegibles <- gt_emory_data %>%
  mutate(
    # eligibility
    eligible = (
      # is eligible
      s1_pregnant == 1 & s1_age_s == 1 & s1_area_s == 1 & s1_biomass == 1 &
        s1_smoke != 1 & s1_move != 1 &  s1_lpg != 1
    ) & (
      # is not ineligible
      !s2_fetus %in% c(0, 2) & !s2_gest %in% c(0, 2) &
        !s2_onefetus %in% c(0, 2) & !s2_participate %in% c(0, 2) &
        s1_ultra != 0
    ),
    # is enrolled
    enrolled = (!is.na(s4_date) & !s4_consent %in% c(0, 2) & !is.na(s4_main_id)),
    # should be enrolled but is not
    pending = eligible & !enrolled &
      (is.na(s1_date) | is.na(s2_date) | is.na(s4_date))
  ) %>%
  filter(
    # from screening
    redcap_event_name == "elegibilidad_arm_1"
  ) %>%
  select(
    redcap_event_name, visit, id,
    eligible, enrolled, pending,
    matches("^(s1|s2|m17|s3|s4)_")
  )


# Tabla de referencia IDs tamizaje y estudio principal
id_screening_enrolled <- gt_emory_data %>%
  filter(redcap_event_name == "elegibilidad_arm_1") %>%
  select(
    id,
    community = s1_community_name,
    s4_main_id
  )


# Mujeres inscritas en el estudio
inscritas <- gt_emory_data %>%
  # Only keep those that are enrolled
  filter(
    id %in% {
      id_screening_enrolled %>%
        filter(!is.na(s4_main_id)) %>%
        pull(s4_main_id) %>%
        as.character()
    }
  ) %>%
  # Gather variable-value pairs
  mutate_at(
    vars(matches("_date")),
    funs(as.character)
  ) %>%
  # Add dates for started H41s
  left_join(
    gt_exposure_start %>%
      filter(gth4x_crf == "h41") %>%
      select(visit, id = record_id, gth4x_date)
  ) %>%
  mutate(
    h41_date = if_else(
      condition = !is.na(gth4x_date),
      true = as.POSIXct(gth4x_date),
      false = as.POSIXct(h41_date)
    )
  ) %>%
  select(-gth4x_date) %>%
  gather(
    key = variable, value = value,
    -id, -visit,
    factor_key = TRUE
  ) %>%
  filter(!is.na(value)) %>%
  # And tag with the visit name (to have only one row per patient)
  unite(variable, visit, variable, sep = ".") %>%
  # Recover one row per patient
  spread(variable, value) %>%
  # Add screening ids
  left_join(
    select(
      id_screening_enrolled,
      community,
      screening_id = id, id = s4_main_id
    ) %>%
      mutate(id = as.character(id))
  ) %>%
  left_join(
    gt_emory_data %>%
      filter(redcap_event_name == "elegibilidad_arm_1", !is.na(m17_ga)) %>%
      select(
        screening_id = id,
        fpp = m17_ga, fpp_method = m17_ga_method, fur = m17_lmp_date,
        screening_date = s1_date, enrollment_date = s4_date,
        s2_date
      )
  ) %>%
  # Regenerate RedCap structure
  gather(variable, value, matches("[.]")) %>%
  filter(!is.na(value)) %>%
  separate(variable, into = c("visit", "variable"), sep = "[.]") %>%
  mutate(
    visit = factor(visit, levels = levels(gt_emory_data$visit))
  ) %>%
  spread(variable, value) %>%
  select(
    redcap_event_name, visit,
    screening_id, id, fpp, fpp_method, fur, s2_date,
    everything()
  )


tamizadas <- elegibles %>%
  filter(
    ! eligible
  ) %>%
  select(id, redcap_event_name, visit, matches("^(s1|s2|m17|s3|s4)_"))


```



```{r tag_location_data}
gt_participants <- gt_participants %>%
  left_join(
    select(inscritas, record_id = id, id_sc = screening_id)
  ) %>%
  mutate(
    record_id = if_else(
      condition = grepl("^3[35]", record_id) & !is.na(id_sc),
      true = id_sc,
      false = record_id
    )
  ) %>%
  select(-record, -id_sc, gps_d_temp)
```



# Qué hacer

## Tabla

```{r}
# Set reference dates
last_report_day <- lubridate::floor_date(Sys.Date(), unit = "1 week") + lubridate::days(3)

# Prepare all events
source("scripts/zz_events_quehacer.R", encoding = "UTF-8")


all_events %>%
  arrange(valid_days) %>%
  filter(event_relevant) %>%
  # Calculate gestational age in weeks and days
  mutate(
    ga = paste0(
      current_days_pregnancy %/% 7, "s ",
      current_days_pregnancy %% 7, "d"
    )
  ) %>%
  select(
    "Fecha de reporte" = report_date,
    "Comunidad" = community,
    "Brazo del estudio" = hh_arm,
    "ID tamizaje" = screening_id,
    "ID estudio" = id,
    "Fecha tamizaje" = screening_date,
    "Fecha inscripción" = enrollment_date,
    "Fecha aleatorización" = randomization_date,
    "FPP" = fpp,
    "Método FPP" = fpp_method,
    "FUR" = fur,
    "Edad gestacional" = ga,
    "Evento" = event_name,
    "Pendientes" = pending,
    "Dias restantes" = valid_days,
    "Salida de embarazada" = salida_pw,
    "Salida de otra adulta" = salida_owa
  ) %>%
  tabla_interactiva()
```




# Elegibles - no inscritas

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla y mapa

<div width=200>
<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em; width=50pt' >
<tbody>
<tr>
<td style='text-align: center;'><img src="img/circle_gray.png" width=16 height=16></img></td>
<td style='text-align: center;'>No data</td>
</tr>
<tr>
<td style='text-align: center;'><img src="img/circle_red.png" width=16 height=16></img></td>
<td style='text-align: center;'>Uploaded</td>
</tr>
<tr>
<td style='text-align: center;'><img src="img/circle_yellow.png" width=16 height=16></img></td>
<td style='text-align: center;'>Reviewed</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: center;'><img src="img/circle_green.png" width=16 height=16></img></td>
<td style='border-bottom: 2px solid grey; text-align: center;'>Complete</td>
</tr>
</tbody>
</table>
</div>

```{r}
# Prepare data for eligibles table and map
mapa_elegibles <- elegibles %>%
  filter(pending) %>%
  # Keep reference values
  mutate(
    fpp = m17_ga,
    ga = if_else(
      condition = m17_ga_method == 1,
      true = m17_lmp_ga,
      false = m17_ultra_ga
    ) %>%
      gsub("([0-9]+)([.]([0-9]*))?", "\\1s \\3d", .)
  ) %>%
  datos_tabla(ga) %>%
  left_join(
    gt_participants %>%
      select(id = record_id, lat, long)
  )

# Wrap data frame in SharedData
sd <- SharedData$new(mapa_elegibles)

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)

```




<!-- # Participantes inscritas -->

```{r}
# Prepare data for enrolled table and map
mapa_inscritas <- inscritas %>%
  # Add randomization date to all visit records
  left_join(
    gt_emory_data %>%
      select(id, hh_arm = s6_arm, randomization_date = s6_date) %>%
      filter(!is.na(randomization_date))
  ) %>%
  # Add location from z10
  left_join(
    gt_participants %>%
      select(screening_id = record_id, lat, long) %>%
      filter(!duplicated(screening_id))
  ) %>%
  # Add **current** gestational age from m17
  left_join(
    gt_emory_data %>%
      filter(grepl("^G", id), !is.na(m17_ga)) %>%
      mutate(
        ga = 280 - as.numeric(m17_ga - Sys.Date(), units = "days"),
        ga = paste0(ga %/% 7, "s ", ga %% 7, "d")
      ) %>%
      select(screening_id = id, ga)
  ) %>%
  mutate(id = paste(id, screening_id, sep = " - ")) %>%
  select(-screening_id) %>%
  split(.$visit) %>%
  subset(subset = sapply(., nrow) > 0) %>%
  map(
    ~ .x %>%
      datos_tabla(
        hh_arm, screening_date, enrollment_date, randomization_date,
        ga, lat, long
      ) %>%
      mutate(
        screening_id = gsub("[^- ]+[- ]*([G0-9]+)", "\\1", id),
        # Tag given study arm
        hh_arm = recode_factor(
          hh_arm,
          `1` = "intervencion",
          `0` = "control",
          .missing = "no-aleatorizadas" 
        )
      ) %>%
      select(
        id, hh_arm, screening_id, ga,
        screening_date, enrollment_date, randomization_date,
        fpp, everything()
      )
  )
```


# Baseline


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("baseline") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# p1


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("p1") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# p2


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("p2") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# salida


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("salida") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# Libres 1


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("libres1") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# Mensual 1


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("mensual1") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# Mensual 2


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("mensual2") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```




# No elegibles

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla

### Tabla de datos disponibles para mujeres elegibles

```{r}
tamizadas %>%
  # Keep reference values
  mutate(
    fpp = m17_ga
  ) %>%
  datos_tabla() %>%
  tabla_interactiva()

```




# Partos esperados

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla

```{r}
inscritas %>%
  filter(visit == "baseline") %>%
  mutate(
    # Tag given study arm
    hh_arm = recode_factor(
      s6_arm,
      `1` = "intervencion",
      `0` = "control",
      .missing = "no-aleatorizadas" 
    ),
    report_date = last_report_day,
    conception_date = fpp - days(280),
    # Calculate reference days
    early_birth = fpp - lubridate::weeks(4),
    preterm_birth = fpp - lubridate::weeks(6),
    preterm_year = lubridate::year(preterm_birth),
    preterm_month = lubridate::month(preterm_birth)
  ) %>%
  select(
    screening_id, id, hh_arm,
    # Add the community name
    community,
    # Leave these dates as reference for the field team
    enrollment_date, randomization_date = s6_date,
    preterm_year, preterm_month,
    fpp, early_birth, preterm_birth
  ) %>%
  arrange(fpp < Sys.Date(), preterm_birth) %>%
  tabla_interactiva()
```

