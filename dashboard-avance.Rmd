---
title: "Control avance HAPIN"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
# load use packages
library(package = "tidyverse")
library(package = "crosstalk")

# Load helper functions
source(file = "scripts/zz_output.R")
```



```{r get_z10}
#------------------------------------------------------------------------------*
# Datos de contacto de participantes ----
#------------------------------------------------------------------------------*

data_base <- DBI::dbConnect(odbc::odbc(), "hapin-gt", dbname = "hapindb")

z10_vars <- c(
  "record", "record_id", "id_estudio",  "municipio", "z10_village", "com_jalapa", 
  "com_jalapa_new", "z10_alti_gps", "z10_lati_gps", "z10_long_gps", 
  "type_goelocation"
)

gt_z10 <- DBI::dbGetQuery(
  conn = data_base,
  statement = paste(
    "select *",
    "from redcap_data",
    "where project_id = 39",
    # "in \"(select project_id from redcap_projects where project_name = 'main_study_gt'\") A",
    "and field_name in",
    paste0(
      "('",
      paste(
        z10_vars,
        collapse = "', '"
      ),
      "')"
    ),
    # get specifically for z10
    "and event_id = 161"
  )
) %>%
  select(record, field_name, value) %>%
  spread(field_name, value) %>%
  select(!!!z10_vars) %>%
  as_tibble()


# Disconnect from database
DBI::dbDisconnect(conn = data_base)


#------------------------------------------------------------------------------*
# Clean up z10 data ----
#------------------------------------------------------------------------------*

# Hard limits on geo-data
gt_participants <- gt_z10 %>%
  # GPS data as numbers
  mutate_at(
    vars(matches("alti|lati|long")),
    funs(
      gsub("[^-0-9.]", "", .) %>%
        as.numeric()
    )
  ) %>%
  # Select GPS data given source type
  mutate(
    long = case_when(
      # type_goelocation == "1" ~ z10_long_tablet,
      type_goelocation == "2" ~ z10_long_gps,
      TRUE ~ NA_real_
    ),
    lat = case_when(
      # type_goelocation == "1" ~ z10_lati_tablet,
      type_goelocation == "2" ~ z10_lati_gps,
      TRUE ~ NA_real_
    ),
    elevation = case_when(
      # type_goelocation == "1" ~ z10_alti_tablet,
      type_goelocation == "2" ~ z10_alti_gps,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-matches("(long|lati|alti)_(gps|tablet)")) %>%
  # Common fixes for GPS data
  mutate(
    # Longitude should be roughly in -90.266 to -89.61
    # and latitude roughly in 14.42 to 14.87
    # If these appear to be reversed, switch
    long_lat_switched = (
      # latitude is negative and < -80
      lat < -80 |
      # longitude is positive and < 80
      between(long, 0, 80)
    ),
    gps_d_temp = if_else(long_lat_switched, long, lat),
    long = if_else(long_lat_switched, lat, long),
    lat = if_else(long_lat_switched, gps_d_temp, lat),
    # Longitude in Jalapa has to be negative
    long = case_when(long > 0 ~ long * -1, TRUE ~ long),
    # Latitude in Jalapa has to be positive,
    lat = case_when(lat < 0 ~ lat * -1, TRUE ~ lat),
    # Elevation can not be below 100 meters
    elevation = case_when(
      elevation < 100 ~ elevation * 100,
      TRUE ~ elevation
    )
  )
```


```{r pregnancy-pre-screening}
#------------------------------------------------------------------------------*
# Datos de contacto de participantes ----
#------------------------------------------------------------------------------*

data_base <- DBI::dbConnect(odbc::odbc(), "hapin-gt", dbname = "hapindb")


s0 <- DBI::dbGetQuery(
  conn = data_base,
  statement = paste(
    "select *",
    "from redcap_data",
    "where project_id = 39",
    # get specifically for s0
    "and event_id = 193"
  )
) %>%
  select(record, field_name, value) %>%
  spread(field_name, value) %>%
  as_tibble()


# Disconnect from database
DBI::dbDisconnect(conn = data_base)
```



```{r get-gt-exposure, eval=TRUE}
#------------------------------------------------------------------------------*
# Datos de inicio de actividades de exposure ----
#------------------------------------------------------------------------------*

data_base <- DBI::dbConnect(odbc::odbc(), "hapin-gt", dbname = "hapindb")

gt_exposure_start <- DBI::dbGetQuery(
  conn = data_base,
  statement = paste(
    "select *",
    "from redcap_data",
    "where project_id in (select project_id from redcap_projects where project_name = 'hapin_guatemala_exposure')"
  )
) %>%
  select(record, field_name, value) %>%
  spread(field_name, value) %>%
  as_tibble()


# Disconnect from database
DBI::dbDisconnect(conn = data_base)

```





```{r get_emory_dictionary}
# Get screening data from Emory export
gt_emory_dict_file <- list.files(
  path = "data/dictionaries", pattern = "MainSt.+csv", full.names = TRUE
) %>%
  data_frame(
    file = .,
    export_time = file %>%
      gsub(".+?_([-0-9_]+).csv", "\\1", .) %>%
      lubridate::ymd(tz = "America/New_York")
  ) %>%
  slice(which.max(export_time))

gt_emory_dictionary <- gt_emory_dict_file %>%
  pull(file) %>%
  read_csv() %>%
  set_names(
    names(.) %>%
      make.names(unique = TRUE, allow_ = TRUE) %>%
      tolower() %>%
      gsub("[.]+", "_", .)
  ) %>%
  rownames_to_column() %>%
  extract(form_name, into = c("crf", "title"), regex = "^([^_]+)_(.*)") %>%
  select(
    rowname, crf, variable = variable_field_name, field_type,
    title, text = field_label,
    config = choices_calculations_or_slider_labels,
    valid_min = text_validation_min, valid_max = text_validation_max,
    relevance = branching_logic_show_field_only_if_,
    required = required_field_
  )
```




```{r get-emory-data}
# Get screening data from Emory export
gt_emory_file <- list.files(
  path = "data/exports", pattern = "MainSt.+csv", full.names = TRUE
) %>%
  data_frame(
    file = .,
    export_time = file %>%
      gsub(".+?_([-0-9_]+).csv", "\\1", .) %>%
      lubridate::ymd_hm(tz = "America/New_York")
  ) %>%
  slice(which.max(export_time))

gt_emory_data <- gt_emory_file %>%
  pull(file) %>%
  read_csv() %>%
  rownames_to_column() %>%
  # Manual removes
  filter(
    !(redcap_event_name == "elegibilidad_arm_1" & id == "33010"),
    !(redcap_event_name == "elegibilidad_arm_1" & id == "G004")
  )
```





```{r, include=FALSE}
gt_emory_data %>%
  select(id, s1_ultra, matches("m17.+(fl|crl|hc)"), s4_main_id) %>%
  filter(s1_ultra == 1) %>%
  print(n = Inf)
```






```{r prepare-women-data}
#------------------------------------------------------------------------------*
# Separate data topics ----
#------------------------------------------------------------------------------*

# Mujeres tamizadas elegibles pero no inscritas
elegibles <- gt_emory_data %>%
  filter(
    # from screening
    redcap_event_name == "elegibilidad_arm_1",
    # is eligible
    (
      s1_pregnant == 1 & s1_age_s == 1 & s1_area_s == 1 & s1_biomass == 1 &
        s1_smoke != 1 & s1_move != 1 &  s1_lpg != 1
    ),
    # is not ineligible
    (
      !s2_fetus %in% c(0, 2) & !s2_gest %in% c(0, 2) &
        !s2_onefetus %in% c(0, 2) & !s2_participate %in% c(0, 2) &
        s1_ultra != 0
    ),
    # not yet enrolled
    (
      is.na(s4_date) |
       ! s4_consent %in% c(0, 2) |
        s2_not_particip %in% c(2, 3, 4)
    ) &
      is.na(s4_main_id)
  ) %>%
  select(rowname, id, redcap_event_name, matches("^(s1|s2|m17|s3|s4)_"))


# Tabla de referencia IDs tamizaje y estudio principal
id_screening_enrolled <- gt_emory_data %>%
  filter(redcap_event_name == "elegibilidad_arm_1") %>%
  select(rowname, id, s4_main_id)


# Mujeres inscritas en el estudio
inscritas <- gt_emory_data %>%
  filter(
    id %in% {
      id_screening_enrolled %>%
        filter(!is.na(s4_main_id)) %>%
        pull(s4_main_id) %>%
        as.character()
    }
  ) %>%
  # Add dates for started H41s
  left_join(
    gt_exposure_start %>%
      filter(gth4x_crf == "h41") %>%
      select(id = record_id, gth4x_date)
  ) %>%
  mutate(
    h41_date = if_else(
      condition = !is.na(gth4x_date),
      true = as.POSIXct(gth4x_date),
      false = as.POSIXct(h41_date)
    )
  ) %>%
  # Add screening ids
  left_join(
    select(id_screening_enrolled, screening_id = id, id = s4_main_id) %>%
      mutate(id = as.character(id))
  ) %>%
  left_join(
    gt_emory_data %>%
      filter(redcap_event_name == "elegibilidad_arm_1", !is.na(m17_ga)) %>%
      select(
        screening_id = id, fpp = m17_ga,
        screening_date = s1_date, enrollment_date = s4_date,
        s2_date
      )
  ) %>%
  select(
    rowname, screening_id, id, redcap_event_name, everything(),
    -matches("^(s1|s2|m17|s3|s4)_"), fpp, s2_date
  )


tamizadas <- gt_emory_data %>%
  filter(
    ! rowname %in% c(
      # elegibles pero no inscritasd
      elegibles$rowname,
      # inscritas
      inscritas$rowname,
      # datos de tamizaje de las inscritas
      gt_emory_data %>%
        filter(
          redcap_event_name == "elegibilidad_arm_1",
          id %in% inscritas$screening_id
        ) %>%
        pull(rowname)
    ),
    redcap_event_name == "elegibilidad_arm_1"
  ) %>%
  select(rowname, id, redcap_event_name, matches("^(s1|s2|m17|s3|s4)_"))


```



```{r tag_location_data}
gt_participants <- gt_participants %>%
  left_join(
    select(inscritas, record_id = id, id_sc = screening_id)
  ) %>%
  mutate(
    record_id = if_else(
      condition = grepl("^3[35]", record_id) & !is.na(id_sc),
      true = id_sc,
      false = record_id
    )
  ) %>%
  select(-long_lat_switched, -record, -id_sc, gps_d_temp)
```



# Elegibles - no inscritas

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla y mapa

<div width=200>
<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em; width=50pt' >
<tbody>
<tr>
<td style='text-align: center;'><img src="img/circle_gray.png" width=16 height=16></img></td>
<td style='text-align: center;'>No data</td>
</tr>
<tr>
<td style='text-align: center;'><img src="img/circle_red.png" width=16 height=16></img></td>
<td style='text-align: center;'>Uploaded</td>
</tr>
<tr>
<td style='text-align: center;'><img src="img/circle_yellow.png" width=16 height=16></img></td>
<td style='text-align: center;'>Reviewed</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: center;'><img src="img/circle_green.png" width=16 height=16></img></td>
<td style='border-bottom: 2px solid grey; text-align: center;'>Complete</td>
</tr>
</tbody>
</table>
</div>

```{r}
# Prepare data for eligibles table and map
mapa_elegibles <- elegibles %>%
  # Keep reference values
  mutate(
    fpp = m17_ga,
    ga = if_else(
      condition = m17_ga_method == 1,
      true = m17_lmp_ga,
      false = m17_ultra_ga
    ) %>%
      gsub("([0-9]+)([.]([0-9]*))?", "\\1s \\3d", .)
  ) %>%
  datos_tabla(ga) %>%
  left_join(
    gt_participants %>%
      select(id = record_id, lat, long)
  )

# Wrap data frame in SharedData
sd <- SharedData$new(mapa_elegibles)

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)

```



# Participantes inscritas

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
# Prepare data for enrolled table and map
mapa_inscritas <- inscritas %>%
  filter(!duplicated(id)) %>%
  mutate(id = paste(id, screening_id, sep = " - ")) %>%
  select(-screening_id) %>%
  rename(randomization_date = s6_date) %>%
  datos_tabla(screening_date, enrollment_date, randomization_date) %>%
  mutate(
    screening_id = gsub("[^- ]+[- ]*([G0-9]+)", "\\1", id)
  ) %>%
  # Add location from z10
  left_join(
    gt_participants %>%
      
      select(screening_id = record_id, lat, long) %>%
      filter(!duplicated(screening_id))
  ) %>%
  # Add **current** gestational age from m17
  left_join(
    gt_emory_data %>%
    filter(grepl("^G", id), !is.na(m17_ga)) %>%
    mutate(
        ga = 280 - as.numeric(m17_ga - Sys.Date(), units = "days"),
        ga = paste0(ga %/% 7, "s ", ga %% 7, "d")
    ) %>%
      select(screening_id = id, ga)
  ) %>%
  select(
    id, screening_id, ga, screening_date, enrollment_date, randomization_date,
    fpp, everything()
  )

# Wrap data frame in SharedData
sd <- SharedData$new(mapa_inscritas)

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)

```




# No elegibles

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla

### Tabla de datos disponibles para mujeres elegibles

```{r}
tamizadas %>%
  # Keep reference values
  mutate(
    fpp = m17_ga
  ) %>%
  datos_tabla() %>%
  tabla_interactiva()

```



# Qué hacer

## Tabla

```{r}
# Prepare all events
source("scripts/zz_events_quehacer.R")

# Set reference dates
last_friday <- lubridate::floor_date(Sys.Date(), unit = "1 week") - lubridate::days(2)
next_friday <- last_friday + lubridate::weeks(1)


all_events %>%
  arrange(screening_id, id, event_name, report_date) %>%
  filter(
    event_relevant,
    report_date %in% as.Date(c(last_friday, next_friday))
  ) %>%
  filter(!duplicated(select(., screening_id, id, event_name))) %>%
  # Calculate gestational age in weeks and days
  mutate(
    ga = paste0(
      current_days_pregnancy %/% 7, "s ",
      current_days_pregnancy %% 7, "d"
    )
  ) %>%
  select(
    "Fecha de reporte" = report_date,
    "ID tamizaje" = screening_id,
    "ID estudio" = id,
    "Fecha tamizaje" = screening_date,
    "Fecha inscripción" = enrollment_date,
    "Fecha aleatorización" = randomization_date,
    "FPP" = fpp,
    "Edad gestacional" = ga,
    "Evento" = event_name
  ) %>%
  tabla_interactiva()
```

