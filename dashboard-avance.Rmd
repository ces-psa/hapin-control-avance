---
title: "Control avance HAPIN"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# load use packages
library(package = "tidyverse")
library(package = "crosstalk")

# Load helper functions
source(file = "scripts/zz_output.R")
```



```{r get-uvg-data}
# Participant information (z10)
source(file = "scripts/0_get_participants.R", encoding = "UTF-8")

# Pre-screening information (s0)
source(file = "scripts/0_get_prescreening.R", encoding = "UTF-8")

# Exposure supporting data (h41 start)
source(file = "scripts/0_get_exposure_start.R", encoding = "UTF-8")
```




```{r get_data}
# Emory RedCap dictionary
source(file = "scripts/0_get_emory_dictionary.R", encoding = "UTF-8")

# Emory RedCap export data
source(file = "scripts/0_get_emory_data.R", encoding = "UTF-8")
```




```{r, include=FALSE}
gt_emory_data %>%
  select(id, s1_ultra, matches("m17.+(fl|crl|hc)"), s4_main_id) %>%
  filter(s1_ultra == 1) %>%
  print(n = Inf)
```




```{r prepare-women-data}
source(file = "scripts/0_classify_data.R", encoding = "UTF-8")
```



```{r tag_location_data}
gt_participants <- gt_participants %>%
  left_join(
    select(inscritas, record_id = id, id_sc = screening_id)
  ) %>%
  mutate(
    record_id = if_else(
      condition = grepl("^3[35]", record_id) & !is.na(id_sc),
      true = id_sc,
      false = record_id
    )
  ) %>%
  select(-record, -id_sc, gps_d_temp)
```



# Qué hacer

## Tabla

```{r}
# Set reference dates
last_report_day <- lubridate::floor_date(Sys.Date(), unit = "1 week") + lubridate::days(3)

# Prepare all events
source("scripts/zz_events_quehacer.R", encoding = "UTF-8")


all_events %>%
  arrange(valid_days) %>%
  filter(event_relevant) %>%
  # Calculate gestational age in weeks and days
  mutate(
    ga = paste0(
      current_days_pregnancy %/% 7, "s ",
      current_days_pregnancy %% 7, "d"
    )
  ) %>%
  select(
    "Fecha de reporte" = report_date,
    "Comunidad" = community,
    "Brazo del estudio" = hh_arm,
    "ID tamizaje" = screening_id,
    "ID estudio" = id,
    "Fecha tamizaje" = screening_date,
    "Fecha inscripción" = enrollment_date,
    "Fecha aleatorización" = randomization_date,
    "FPP" = fpp,
    "Método FPP" = fpp_method,
    "FUR" = fur,
    "Edad gestacional" = ga,
    "Evento" = event_name,
    "Pendientes" = pending,
    "Dias restantes" = valid_days,
    "Salida de embarazada" = salida_pw,
    "Salida de otra adulta" = salida_owa
  ) %>%
  tabla_interactiva()
```




# Elegibles - no inscritas

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla y mapa

<div width=200>
<table class='gmisc_table' style='border-collapse: collapse; margin-top: 1em; margin-bottom: 1em; width=50pt' >
<tbody>
<tr>
<td style='text-align: center;'><img src="img/circle_gray.png" width=16 height=16></img></td>
<td style='text-align: center;'>No data</td>
</tr>
<tr>
<td style='text-align: center;'><img src="img/circle_red.png" width=16 height=16></img></td>
<td style='text-align: center;'>Uploaded</td>
</tr>
<tr>
<td style='text-align: center;'><img src="img/circle_yellow.png" width=16 height=16></img></td>
<td style='text-align: center;'>Reviewed</td>
</tr>
<tr>
<td style='border-bottom: 2px solid grey; text-align: center;'><img src="img/circle_green.png" width=16 height=16></img></td>
<td style='border-bottom: 2px solid grey; text-align: center;'>Complete</td>
</tr>
</tbody>
</table>
</div>

```{r}
# Prepare data for eligibles table and map
mapa_elegibles <- elegibles %>%
  filter(pending) %>%
  # Keep reference values
  mutate(
    fpp = m17_ga,
    ga = if_else(
      condition = m17_ga_method == 1,
      true = m17_lmp_ga,
      false = m17_ultra_ga
    ) %>%
      gsub("([0-9]+)([.]([0-9]*))?", "\\1s \\3d", .)
  ) %>%
  datos_tabla(ga) %>%
  left_join(
    gt_participants %>%
      select(id = record_id, lat, long)
  )

# Wrap data frame in SharedData
sd <- SharedData$new(mapa_elegibles)

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)

```




<!-- # Participantes inscritas -->

```{r}
# Prepare data for enrolled table and map
mapa_inscritas <- inscritas %>%
  # Add randomization date to all visit records
  left_join(
    gt_emory_data %>%
      select(id, hh_arm = s6_arm, randomization_date = s6_date) %>%
      filter(!is.na(randomization_date))
  ) %>%
  # Add location from z10
  left_join(
    gt_participants %>%
      select(screening_id = record_id, lat, long) %>%
      filter(!duplicated(screening_id))
  ) %>%
  # Add **current** gestational age from m17
  left_join(
    gt_emory_data %>%
      filter(grepl("^G", id), !is.na(m17_ga)) %>%
      mutate(
        ga = 280 - as.numeric(m17_ga - Sys.Date(), units = "days"),
        ga = paste0(ga %/% 7, "s ", ga %% 7, "d")
      ) %>%
      select(screening_id = id, ga)
  ) %>%
  mutate(id = paste(id, screening_id, sep = " - ")) %>%
  select(-screening_id) %>%
  split(.$visit) %>%
  subset(subset = sapply(., nrow) > 0) %>%
  map(
    ~ .x %>%
      datos_tabla(
        hh_arm, screening_date, enrollment_date, randomization_date,
        ga, lat, long
      ) %>%
      mutate(
        screening_id = gsub("[^- ]+[- ]*([G0-9]+)", "\\1", id),
        # Tag given study arm
        hh_arm = recode_factor(
          hh_arm,
          `1` = "intervencion",
          `0` = "control",
          .missing = "no-aleatorizadas" 
        )
      ) %>%
      select(
        id, hh_arm, screening_id, ga,
        screening_date, enrollment_date, randomization_date,
        fpp, everything()
      )
  )
```


# Baseline


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("baseline") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# p1


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("p1") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# p2


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("p2") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# salida


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("salida") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# Libres 1


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("libres1") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# Mensual 1


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("mensual1") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```


# Mensual 2


Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`


## Mapa

```{r}
sd <- mapa_inscritas %>%
  magrittr::extract2("mensual2") %>%
  # Wrap data frame in SharedData
  SharedData$new()

# Use SharedData like a dataframe with Crosstalk-enabled widgets
bscols(
  leaflet::leaflet(sd, width = "100%", height = 1000) %>%
    leaflet::addTiles() %>%
    leaflet::addCircleMarkers(
      lng = ~long, lat = ~lat,
      radius = 3, label = ~id
    ),
  tabla_interactiva(sd),
  device = "xs"
)
```




# No elegibles

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla

### Tabla de datos disponibles para mujeres elegibles

```{r}
tamizadas %>%
  # Keep reference values
  mutate(
    fpp = m17_ga
  ) %>%
  datos_tabla() %>%
  tabla_interactiva()

```




# Partos esperados

Datos exportados en `r lubridate::with_tz(gt_emory_file$export_time, 'America/Guatemala')`

## Tabla

```{r}
inscritas %>%
  filter(visit == "baseline") %>%
  mutate(
    # Tag given study arm
    hh_arm = recode_factor(
      s6_arm,
      `1` = "intervencion",
      `0` = "control",
      .missing = "no-aleatorizadas" 
    ),
    report_date = last_report_day,
    conception_date = fpp - days(280),
    # Calculate reference days
    early_birth = fpp - lubridate::weeks(4),
    preterm_birth = fpp - lubridate::weeks(6),
    preterm_year = lubridate::year(preterm_birth),
    preterm_month = lubridate::month(preterm_birth)
  ) %>%
  select(
    screening_id, id, hh_arm,
    # Add the community name
    community,
    # Leave these dates as reference for the field team
    enrollment_date, randomization_date = s6_date,
    preterm_year, preterm_month,
    fpp, early_birth, preterm_birth
  ) %>%
  arrange(fpp < Sys.Date(), preterm_birth) %>%
  tabla_interactiva()
```

