---
title: "REPORTE DE AVANCES HAPIN"
output: html_document
---

# Reporte separado en Pesta√±as {.tabset}

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# load use packages
library(package = "tidyverse")
library(package = "crosstalk")
library(package= "kableExtra")
library("formattable")
library(gt)
library(palmerpenguins)
library(pivottabler)
library(ggplot2)
library(cowplot) 
library("RColorBrewer")
library(kableExtra)


###CARGA DE DATOS EMORY Y UVG
# Pre-screening information (s0)
#source(file = "scripts/0_get_prescreening.R", encoding = "UTF-8")

# Load helper functions
#source(file = "scripts/zz_output.R")

# Emory RedCap dictionary
source(file = "scripts/0_get_emory_dictionary.R", encoding = "UTF-8")

# Emory RedCap export data
source(file = "scripts/0_get_emory_data.R", encoding = "UTF-8")

# Emory RedCap export data entericas
source(file = "scripts/0_get_entericas_data.R", encoding = "UTF-8")

#salidas
source(file = "scripts/0_get_salidas.R", encoding = "UTF-8")

#datos de entregas de gas y cambios de cilindro
source(file = "scripts/1_all_gas_action.R", encoding = "UTF-8")
source(file = "scripts/0_get_cambio_cilindro.R", encoding = "UTF-8")

# Emory HAPIN II  
source(file = "scripts/0_get_hapinII.R", encoding = "UTF-8")

# Stops knitting if lpg delivery data is not up to date
#source(file = "scripts/uso-estufas.R", encoding = "UTF-8")

#fecha de la semana ----
fecha1<-'2022-11-04'
#fecha2<-'2022-04-10' ----
fecha2<-'2022-11-18'
f_week1<-'2022-11-04'
f_week2<-'2022-11-18'

```

#### ***Semana del  "`r as.Date(fecha1) %>% format(.,"%A %d %B  %Y")`" al "`r as.Date(fecha2) %>% format(.,"%A %d %B  %Y")`" *** 
#### *Reporte Generado el  "`r Sys.Date() %>% format(.,"%A %d %B  %Y")`"*

## HAPIN

#### LISTADO DE: "PARTICIPACION"

```{r inscritas, echo=FALSE}
#acumulado inscritas
inscritas<-gt_emory_data_arm1 %>% select("id_tamizaje"=id, id=s4_main_id,s4_date) %>% filter(!is.na(id)) %>%
  left_join(gt_emory_data_arm1 %>% select(id_tamizaje=id,m17_date, m17_ga) %>% filter(!is.na(m17_date)))

#inscritas acumulado y semana
inscritas_acumulado<-inscritas %>% count()
inscritas_semana <- inscritas %>% filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()

#embarazadas
inscritas_embarazadas_acumulado<-inscritas %>% mutate(
      type = if_else(
        condition = grepl("^35", id),
        true = "oaw",
        false = "pw"
      )
      ) %>% filter(type=="pw") %>% count()

inscritas_embarazadas_semana<-inscritas %>% mutate(
      type = if_else(
        condition = grepl("^35", id),
        true = "oaw",
        false = "pw"
      )
      ) %>% filter(type=="pw") %>% filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()
#adultas
inscritas_adultas_acumulado<-inscritas %>% mutate(
      type = if_else(
        condition = grepl("^35", id),
        true = "oaw",
        false = "pw"
      )
      ) %>% filter(type=="oaw") %>%
  count()

inscritas_adultas_semana<-inscritas %>% mutate(
      type = if_else(
        condition = grepl("^35", id),
        true = "oaw",
        false = "pw"
      )
      ) %>% filter(type=="oaw") %>% 
  filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()

#adultas
inscritas_solo_adultas_acumulado<-inscritas %>% mutate(
      type = if_else(
        condition = grepl("^35", id),
        true = "oaw",
        false = "pw"
      )
      ) %>% filter(type=="oaw") %>% 
  count()

inscritas_solo_adultas_semana<-inscritas %>% mutate(
      type = if_else(
        condition = grepl("^35", id),
        true = "oaw",
        false = "pw"
      )
      ) %>% filter(type=="oaw") %>%
  filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()



#rechazos en S4
s4_rechazo_acumulado<- gt_emory_data_arm1 %>% filter(!is.na(s4_date)) %>% filter(s4_consent=="0") %>% count()
s4_rechazo_semana<- gt_emory_data_arm1 %>% filter(!is.na(s4_date)) %>% filter(s4_consent=="0") %>% filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()


#conteos de s6 por semana y totales
s6<-gt_emory_data_arm2 %>% select(id,s6_date) %>% filter(!is.na(s6_date))
s6_acumulado<-s6 %>% count()
s6_semana<-s6 %>% select(id,s6_date) %>% filter(s6_date >=fecha1 & s6_date<=fecha2) %>% count()

salida_after_s6 <- s6 %>% left_join(salidas) %>%left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date)) %>% select(id, e3_date)
) %>% 
  mutate(
    dias_s6_e3=e3_date-s6_date
    ) %>% filter(sale==1) %>% count()
#salidas acumulado y semana
salidas_acumulado<-salidas %>% count()
#salidas con e3_reason acumulado
salidas_razon_acumulado<-salidas %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date)) %>% select(id, e3_date, e3_reason) %>% 
    mutate(razon= 
             recode(
                    e3_reason, "1"="Finalizacion del estudio",
                    "2"="No elegible",
                    "3"="Retiro voluntario de la participante",
                    "4"="Retirada por el equipo del estudio",
                    "5"="Se mudo del area de estudio",
                    "6"="Fallecio",
                    "7"="Perdido durante el seguimiento",
                    "8"="Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino",
                    "555"="Otro"
                    )
           ) 
) %>% select(id, razon)




#salidas con e3_reason semanal
salidas_razon_semanal<-salidas %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_exit)) %>% select(id, e3_date_exit, e3_reason) %>% 
    mutate(razon= 
             recode(
                    e3_reason, 
                    "1"="Finalizacion del estudio",
                    "2"="No elegible",
                    "3"="Retiro voluntario de la participante",
                    "4"="Retirada por el equipo del estudio",
                    "5"="Se mudo del area de estudio",
                    "6"="Fallecio",
                    "7"="Perdido durante el seguimiento",
                    "8"="Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino",
                    "555"="Otro"
                    )
    )
) %>%  filter(e3_date_exit>=fecha1 & e3_date_exit<=fecha2) %>%  select(id, razon)

salidas_semana<-salidas %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_exit)) %>% select(id, e3_date_exit)
) %>%  filter(e3_date_exit >=fecha1 & e3_date_exit<=fecha2) %>% count()


#activas embarazadas y Adultas
activas<-inscritas %>% anti_join(
  salidas %>% select(id)
) 

activas_acumulado<-activas %>% count()
activas_semana<-activas %>% filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()

activas_embarazadas_acumulado<-activas %>% mutate(
    type = if_else(
      condition = grepl("^35", id),
      true = "oaw",
      false = "pw"
    )
  ) %>% filter(type=="pw") %>% count()
  
activas_embarazadas_semana<-activas %>% mutate(
    type = if_else(
      condition = grepl("^35", id),
      true = "oaw",
      false = "pw"
    )
  ) %>% filter(type=="pw") %>% filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()
  
activas_adultas_acumulado<-activas %>% mutate(
    type = if_else(
      condition = grepl("^35", id),
      true = "oaw",
      false = "pw"
    )
  ) %>% filter(type=="oaw") %>%
  count()
  
activas_adultas_semana<-activas %>% mutate(
    type = if_else(
      condition = grepl("^35", id),
      true = "oaw",
      false = "pw"
    )
  ) %>% filter(type=="oaw") %>% filter(s4_date >=fecha1 & s4_date<=fecha2) %>% count()

#make table inscritas
actividad_inscritas<-c("Inscritas en este periodo", "--Embarazadas", "--Embarazada + Adulta Mayor", "Hogares elegibles que no aceptaron participar", "Hogares que se retiraron del Estudio", 
                       "--Finalizacion del estudio",
                       "--No elegible",
                       "--Retiro voluntario de la participante",
                       "--Se mudo del area de estudio",
                       "--Fallecio",
                       "--Perdido durante el seguimiento",
                       "--Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino",
                       "--Otro",
                       "Hogares participando en el estudio",
                       "--Embarazadas participando", "--Embarazadas + Adulta participando")
reporte_inscritas<-data.frame(actividad_inscritas)
reporte_inscritas %>% mutate(
  semana = case_when(
    actividad_inscritas=="Inscritas en este periodo" ~ inscritas_semana$n,
    actividad_inscritas=="--Embarazadas" ~ inscritas_embarazadas_semana$n,
    actividad_inscritas=="--Embarazada + Adulta Mayor" ~ inscritas_adultas_semana$n,
    actividad_inscritas=="Hogares elegibles que no aceptaron participar" ~ s4_rechazo_semana$n,
    actividad_inscritas=="Hogares que se retiraron del Estudio" ~ salidas_semana$n,
    actividad_inscritas=="--Finalizacion del estudio" ~ salidas_razon_semanal %>% filter(razon=="Finalizacion del estudio") %>% count() %>% .$n,
    actividad_inscritas=="--No elegible" ~ salidas_razon_semanal %>% filter(razon=="No elegible") %>% count() %>% .$n,
    actividad_inscritas=="--Retiro voluntario de la participante" ~ salidas_razon_semanal %>% filter(razon=="Retiro voluntario de la participante") %>% count() %>% .$n,
    actividad_inscritas=="--Se mudo del area de estudio" ~ salidas_razon_semanal %>% filter(razon=="Se mudo del area de estudio") %>% count() %>% .$n,
    actividad_inscritas=="--Fallecio" ~ salidas_razon_semanal %>% filter(razon=="Fallecio") %>% count() %>% .$n,
    actividad_inscritas=="--Perdido durante el seguimiento" ~ salidas_razon_semanal %>% filter(razon=="Perdido durante el seguimiento") %>% count() %>% .$n,
    actividad_inscritas=="--Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino" ~ salidas_razon_semanal %>% filter(razon=="Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino") %>% count() %>% .$n,
    actividad_inscritas=="--Otro" ~ salidas_razon_semanal %>% filter(razon=="Otro") %>% count() %>% .$n,
     actividad_inscritas=="Hogares participando en el estudio" ~ activas_semana$n,
     actividad_inscritas=="--Embarazadas participando" ~ activas_embarazadas_semana$n,
     actividad_inscritas=="--Embarazadas + Adulta participando" ~ activas_adultas_semana$n,
    TRUE ~ NA_integer_
  )
) %>%mutate(
  acumulado = case_when(
    actividad_inscritas=="Inscritas en este periodo" ~ inscritas_acumulado$n,
    actividad_inscritas=="--Embarazadas" ~ inscritas_embarazadas_acumulado$n,
    actividad_inscritas=="--Embarazada + Adulta Mayor" ~ inscritas_adultas_acumulado$n,
    actividad_inscritas=="Hogares elegibles que no aceptaron participar" ~ s4_rechazo_acumulado$n,
    actividad_inscritas=="Hogares que se retiraron del Estudio" ~ salidas_acumulado$n,
    actividad_inscritas=="--Finalizacion del estudio" ~ salidas_razon_acumulado %>% filter(razon=="Finalizacion del estudio") %>% count() %>% .$n,
    actividad_inscritas=="--No elegible" ~ salidas_razon_acumulado %>% filter(razon=="No elegible") %>% count() %>% .$n,
    actividad_inscritas=="--Retiro voluntario de la participante" ~ salidas_razon_acumulado %>% filter(razon=="Retiro voluntario de la participante") %>% count() %>% .$n,
    actividad_inscritas=="--Se mudo del area de estudio" ~ salidas_razon_acumulado %>% filter(razon=="Se mudo del area de estudio") %>% count() %>% .$n,
    actividad_inscritas=="--Fallecio" ~ salidas_razon_acumulado %>% filter(razon=="Fallecio") %>% count() %>% .$n,
    actividad_inscritas=="--Perdido durante el seguimiento" ~ salidas_razon_acumulado %>% filter(razon=="Perdido durante el seguimiento") %>% count() %>% .$n,
    actividad_inscritas=="--Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino" ~ salidas_razon_acumulado %>% filter(razon=="Madre:Aborto/Aborto espontaneo, mortinato, muerte del nino") %>% count() %>% .$n,
    actividad_inscritas=="--Otro" ~ salidas_razon_acumulado %>% filter(razon=="Otro") %>% count() %>% .$n,
    actividad_inscritas=="Hogares participando en el estudio" ~ activas_acumulado$n,
     actividad_inscritas=="--Embarazadas participando" ~ activas_embarazadas_acumulado$n,
     actividad_inscritas=="--Embarazadas + Adulta participando" ~ activas_adultas_acumulado$n,
    TRUE ~ NA_integer_
  )
) %>% select("Actividad"=actividad_inscritas, "Quincenal     " = semana, "Acumulado     "=acumulado) %>% 
   
  mutate(Actividad=cell_spec(Actividad,"html", color = "blue",align = "c", bold = T),
                                     `En la quincena`= select(., contains("Quincenal")) %>% rowSums(., na.rm = TRUE),
                                             `En la quincena`= cell_spec(`En la quincena`, "html", color = "blue", bold=T)
                                             ) %>% 
  kable(caption = paste(""), escape = F) %>% 
  kable_styling("hover", full_width = F) %>% 
  column_spec(2, width = "5cm") %>% 
  add_header_above(c(" ", "INSCRITAS Y RETIROS"=2, "Total"=1))
  

```

#### REPORTE AVANCES: "CONTEO DE ADULTAS BL HASTA B5"
##### Reporte incluye datos de hapin 1 y hapin 1.5

```{r CONTEO_OWAS, echo=FALSE}
#datos para historia clinica
historia_clinica<-gt_emory_data_arm2  %>% filter(!is.na(a23_visit)) %>% select(id, a23_visit, visit) %>% group_by(visit, a23_visit) %>% count() %>% bind_rows(
gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(a23_meds)) %>% transmute(id, a23_visit="2", visit="b5") %>% group_by(visit,a23_visit) %>% count()
)
#datos para presion arterial
presion_arterial<-gt_emory_data_arm2 %>% filter(!is.na(a24_sbp1)) %>% select(id, a24_sbp1, visit) %>% group_by(visit) %>% count() %>% bind_rows(
gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(a24_sbp1)) %>% transmute(id, a24_sbp1, visit="b5") %>% group_by(visit) %>% count()
)

#sangre seca b10_to_spots
sangre_seca<-gt_emory_data_arm2 %>% filter(!is.na(b10_to_spots) | !is.na(b10_to_spots_2)) %>% filter(
  b10_to_spots=="1" | b10_to_spots_2=="1"
) %>%  select(id, visit) %>% group_by(visit) %>% count() %>% bind_rows(
gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(b10_to_spots)) %>% filter(
  b10_to_spots=="1"
) %>%  transmute(id, visit="b5") %>% group_by(visit) %>% count()
)

#cimt
cimt<-gt_emory_data_arm2 %>% filter(!is.na(a26_image)) %>% select(id, visit) %>%
 group_by(visit) %>% count() %>% bind_rows(
gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(a26_image)) %>% transmute(id, visit="b5") %>% group_by(visit) %>% count()
)


tipos_salida<-gt_emory_data_arm2 %>% filter(!is.na(e3_date_exit_o)) %>% arrange(e3_last_visit_o) %>% transmute(id, visit=recode(e3_last_visit_o, "0"="  elegibilidad", "1"=" baseline",
                                                                                     "2"=" p1", "3"=" p2", "5"="b1", "6"="b2", "7"="b3", "8"="b4"
)                                                                                  ) %>% group_by(visit) %>% count()

#armar tabla para reportar datos de adultas
Visita<-c("Elegibilidad", "Baseline", "P1", "P2","B1","B2","B3","B4","B5")
reporte_adultas<-data.frame(Visita)
reporte_adultas %>% left_join(
  historia_clinica %>% ungroup %>% transmute(Visita=recode(visit,
   "baseline"="Baseline" , "p1"="P1","p2"="P2","b1"="B1","b2"="B2",
   "b3"="B3","b4"="B4","b5"="B5"
  ),
                                 `Historia clinica a23 (a23_vit)`=n) %>% select(Visita,`Historia clinica a23 (a23_vit)`)
) %>% left_join(
  presion_arterial %>% ungroup %>% transmute(Visita=recode(visit,
   "baseline"="Baseline" , "p1"="P1","p2"="P2","b1"="B1","b2"="B2",
   "b3"="B3","b4"="B4","b5"="B5"
  ), `Presion arterial a24b (a24_sbp1)`=n
) %>% select(Visita,`Presion arterial a24b (a24_sbp1)`)
) %>% left_join(
  sangre_seca %>% ungroup %>% transmute(Visita=recode(visit,
   "baseline"="Baseline" , "p1"="P1","p2"="P2","b1"="B1","b2"="B2",
   "b3"="B3","b4"="B4","b5"="B5"
  ), `Sangre seca b10 √≥ b10oaw (b10_to_spots)`=n
) %>% select(Visita,`Sangre seca b10 √≥ b10oaw (b10_to_spots)`)
) %>% left_join(
  cimt %>% ungroup %>% transmute(Visita=recode(visit,
   "baseline"="Baseline" , "p1"="P1","p2"="P2","b1"="B1","b2"="B2",
   "b3"="B3","b4"="B4","b5"="B5"
  ), `Cimt (a26_image)`=n
) %>% select(Visita,`Cimt (a26_image)`)
) %>% left_join(
  tipos_salida %>%  ungroup %>% transmute(Visita=recode(visit,"  elegibilidad"="Elegibilidad",
   " baseline"="Baseline" , " p1"="P1"," p2"="P2","b1"="B1","b2"="B2",
   "b3"="B3","b4"="B4","b5"="B5"
  ), `Salidas  ultima visita E3(e3_last_visit_o)`=n
) %>% select(Visita,`Salidas  ultima visita E3(e3_last_visit_o)`)
) %>% mutate(Visita=cell_spec(Visita,"html", color = "blue",align = "c", bold = T)) %>%  kable(caption = paste("  "), escape = F) %>%  kable_styling("hover", full_width = F) %>%
  column_spec(1, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c("  ", "CONTEO DE DATOS DE OWAS"=5))

```



## HAPIN 24 MESES
#### CONTEOS: "HAPIN-II  B5"
##### Inicio de actividad: 16 de marzo del 2021

```{r consentimientos_hapinII, echo=FALSE, warning = FALSE, message = FALSE}

##SACAR LISTADO DE CANDIDATOS HAPIN 24m
#Ni√±os
candidatos_ninos<-gt_emory_data_arm2 %>% filter(!is.na(c30_dob)) %>% select(id, c30_dob) %>% mutate(
  ventana=as.Date(c30_dob) + lubridate::days(330),
  un_anio=as.Date(c30_dob) + lubridate::days(365)
) %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_c)) %>% select(id, e3_date_exit_c, e3_reason_c) 
  
) %>% anti_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date)) %>% select(id, e3_reason) %>% filter(
    e3_reason=="8"
  )
) %>%  
   mutate(
   completo_b4=case_when(
    e3_reason_c=="1" ~ "Si",
    TRUE ~ NA_character_
   )
 ) %>% 
 select(id, fecha_nacimiento=c30_dob, completo_b4) %>% mutate(
  `12_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*12)),
  `24_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*24)),
  `36_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*36)),
  `48_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*48)),
  `60_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*60))
)

#Adultas
candidatos_adultas<-gt_emory_data_arm2 %>% filter(!is.na(s6_arm)) %>% select(id) %>% mutate(
  type=if_else(
    grepl("^35",id),
    "owa",
    "pwg" )
) %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_o)) %>% select(id, e3_reason_o) %>%  
   mutate(
   completo_b4=case_when(
    e3_reason_o=="1" ~ "Si",
    TRUE ~ NA_character_
   )
 )
) %>% filter(type=="owa") 
  

#consentimientos
#Ni√±os
consentimientos_madre<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>% mutate(
  type=if_else(
    grepl("^35",id), "owa","pwg"
  )
) %>% filter(s4_consent=="1") %>%  left_join(
  candidatos_ninos %>% select(id, completo_b4)
) %>% filter(completo_b4=="Si")

#Adultas
consentimientos_owa<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) %>% filter(!is.na(s4_ocon_date)) %>% left_join(
  candidatos_adultas %>% select(id, completo_b4)
) %>% filter(!is.na(completo_b4))


#RECHAZOS
#NI√ëOS
rechazos_33<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) %>% filter(type=="pwg") %>% left_join(
  candidatos_ninos %>% select(id, completo_b4)
) %>%  filter(s4_consent=="0" & !is.na(completo_b4))

rechazos_35<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) %>% filter(type=="owa") %>% left_join(
  candidatos_ninos %>% select(id, completo_b4)
) %>%  filter(s4_consent=="0" & !is.na(completo_b4))

#Rechazo Adultas completaron b4

rechazos_adultas_completo_b4 <-  gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) %>% filter(type=="owa") %>% left_join(
  candidatos_adultas %>% select(id, completo_b4)
) %>% filter(!is.na(completo_b4)) %>% filter(is.na(s4_ocon_date))

#consentimientos y rechazos de los que no completaron B4
  #Ni√±os denominador 6
  #consentidos 33
ninos_consentidos_33_nocompleto_b4<-candidatos_ninos %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% left_join(
   gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
)
) %>% filter(type=="pwg") %>% filter(s4_consent=="1")
  
#consentidos 35
ninos_consentidos_35_nocompleto_b4<-candidatos_ninos %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% left_join(
   gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
)
) %>% filter(type=="owa") %>% filter(s4_consent=="1")
#Adultas consentidas que no completaron b4 denominador 26
adultas_consentidos_no_b4<- candidatos_adultas %>% select(id, completo_b4) %>% filter(is.na(completo_b4)) %>% 
  left_join(
    gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) 
) %>% filter(!is.na(s4_ocon_date))

#Rechazos no completaron B4 denominador 6
#Ni√±os
rechazos_ninos_no_b4<-candidatos_ninos %>% select(id, completo_b4) %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% left_join(
   gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
)
) %>% filter(type=="pwg") %>% filter(s4_consent=="0") 

#Ni√±os
rechazos_ninos_no_b4_33<-candidatos_ninos %>% select(id, completo_b4) %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% left_join(
   gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
)
) %>% filter(type=="pwg") %>% filter(s4_consent=="0") 

rechazos_ninos_no_b4_35<-candidatos_ninos %>% select(id, completo_b4) %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% left_join(
   gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
)
) %>% filter(type=="owa") %>% filter(s4_consent=="0") 

#Adultas no b4 denominador 26, 2 no se visitaron
rechazos_adultas_no_b4<-candidatos_adultas %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% 
  left_join(
    gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) 
) %>% filter(!is.na(s4_date)) %>% filter(is.na(s4_ocon_date))

#No completaron B4 y no se visitaron
#Ni√±os
novisitamos_ninos_no_b4<-candidatos_ninos %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>%  left_join(
    gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date)
) %>% filter(is.na(s4_date))

#adultas
novisitamos_adultas_no_b4<-candidatos_adultas %>% filter(is.na(completo_b4)) %>% select(id, completo_b4) %>% left_join(
  gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date) %>%  mutate(
  type=if_else(grepl("^35",id), "owa","pwg")
) 
) %>% filter(is.na(s4_date))


#consentimientos sangre seca
#conteso de sangre en mujer madre en b4
dt_sangre_seca<- gt_emory_data_arm2 %>% filter(!is.na(b10_date)) %>% filter(visit=="b4") %>% select(
  id,
  b10_date,
  b10_by,
  b10_tm_spots
) %>% arrange(desc(b10_date)) %>% filter(b10_tm_spots=="1") %>% left_join(
  gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(s4_date)) %>% select(id, s4_date)
  ) %>% filter(!is.na(s4_date))

dt_sangre_seca<-dt_sangre_seca %>% mutate(
  type=if_else(grepl("^35",id),"owa","pwg")
)

consentimientos_sangre_seca<-dt_sangre_seca %>% left_join(
  gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(s4_date)) %>% select(id,s4_date, s4_consent, s4_consent_c, s4_owa)
)


#tabla adultas consentidos hapin 24m


#consentimientos_sangre_seca %>% group_by(type) %>% count()

#GENERAR TABLA CON SEMANAL ACUMULADO DE CONSENTIMIENTOS
#make table CONSENTIMIENTOS HAPIN II
actividad_consentimientos<-c("Hogares consentidos HAPIN II",
                             "--Hogares 33", "--Hogares 35",
                             "Hogares que rechazaron HAPIN II",
                       "--Rechazos Hogares 33",
                       "--Rechazos Hogares 35"
                       #"Hogares consentidos Sangre seca en B4"
                        )
reporte_consentimientos<-data.frame(actividad_consentimientos)
reporte_consentimientos %>% mutate(
  semana = case_when(
    actividad_consentimientos=="Hogares consentidos HAPIN II" ~ consentimientos_madre %>% filter(s4_date>=fecha1 & s4_date<=fecha2)   %>%  count() %>% .$n,
     actividad_consentimientos=="--Hogares 33" ~ consentimientos_madre %>% filter(s4_date>=fecha1 & s4_date<=fecha2)  %>%  filter(type=="pwg") %>% count() %>%  .$n,

    actividad_consentimientos=="--Hogares 35" ~ consentimientos_madre %>% filter(s4_date>=fecha1 & s4_date<=fecha2)  %>%  filter(type=="owa") %>% count() %>%  .$n,

     actividad_consentimientos=="Hogares que rechazaron HAPIN II" ~  rechazos_33 %>% filter(s4_date>=fecha1 & s4_date<=fecha2) %>%  count() %>% .$n + rechazos_35 %>% filter(s4_date>=fecha1 & s4_date<=fecha2) %>%  count() %>% .$n ,
    actividad_consentimientos=="--Rechazos Hogares 33" ~ rechazos_33 %>% filter(s4_date>=fecha1 & s4_date<=fecha2) %>%  count() %>% .$n,
     actividad_consentimientos=="--Rechazos Hogares 35" ~ rechazos_35 %>% filter(s4_date>=fecha1 & s4_date<=fecha2) %>%  count() %>% .$n,

     actividad_consentimientos=="Hogares consentidos Sangre seca en B4" ~ consentimientos_sangre_seca %>% filter(s4_date>=fecha1 & s4_date<=fecha2) %>% filter(s4_consent=="1") %>%  count() %>% .$n,

    TRUE ~ NA_integer_
  )
) %>%mutate(
  acumulado = case_when(

     actividad_consentimientos=="Hogares consentidos HAPIN II" ~ consentimientos_madre %>%  count() %>% .$n,
     actividad_consentimientos=="--Hogares 33" ~ consentimientos_madre %>%  filter(type=="pwg") %>% count() %>%  .$n,
    actividad_consentimientos=="--Hogares 35" ~ consentimientos_madre %>%  filter(type=="owa") %>% count() %>%  .$n,
    actividad_consentimientos=="Hogares que rechazaron HAPIN II" ~  rechazos_33 %>%  count() %>% .$n + rechazos_35 %>%  count() %>% .$n ,
    actividad_consentimientos=="--Rechazos Hogares 33" ~ rechazos_33 %>%  count() %>% .$n,
     actividad_consentimientos=="--Rechazos Hogares 35" ~ rechazos_35 %>%  count() %>% .$n,

     actividad_consentimientos=="Hogares consentidos Sangre seca en B4" ~ consentimientos_sangre_seca %>% filter(s4_consent=="1") %>%  count() %>% .$n,

    TRUE ~ NA_integer_
  )
) %>% select("Actividad"=actividad_consentimientos, "Quincenal     " = semana, "Acumulado     "=acumulado) %>%

   mutate(Actividad=cell_spec(Actividad,"html", color = "blue",align = "c", bold = T)) %>%
  #                                    `En la quincena`= select(., contains("Quincenal")) %>% rowSums(., na.rm = TRUE),
  #                                            `En la quincena`= cell_spec(`En la quincena`, "html", color = "blue", bold=T)
  #                                            ) %>%
  kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c(" ", "REPORTE CONSENTIMIENTOS NI√ëOS B5 HAPIN II (Denominador 744 ni√±os finalizaron hapin1)"=2))

#TABLA CONSENTIMIENTOS ADULTAS 24m
# consentimientos_adultas<-gt_emory_data_arm2 %>% filter(!is.na(s6_arm)) %>% select(id) %>% mutate(
#     type=if_else(grepl("^35",id),"owa","pwg")
# ) %>% filter(type=="owa") %>% left_join(
#   candidatos %>% transmute(id, candidato_24m="si")
# ) %>% left_join(
#   gt_hapin_II_data %>%filter(redcap_event_name=="24_month_arm_1") %>%   filter(!is.na(s4_date)) %>% select(id, s4_date, s4_consent, s4_consent_c, s4_owa, s4_ocon_date)
# )

actividad_consentimientos_owa<-c("Adultas consentidas HAPIN II",
                                 "Adultas que rechazaron HAPIN II"
                                #"Hogares consentidos Sangre seca en B4"
                        )
actividad_consentimientos_owa<-data.frame(actividad_consentimientos_owa)
actividad_consentimientos_owa %>% mutate(
  semana = case_when(
    actividad_consentimientos_owa=="Adultas consentidas HAPIN II" ~ consentimientos_owa %>% filter(s4_date>=fecha1 & s4_date<=fecha2)   %>%  count() %>% .$n,
    actividad_consentimientos_owa=="Adultas que rechazaron HAPIN II" ~ rechazos_adultas_completo_b4 %>% filter(s4_date>=fecha1 & s4_date<=fecha2) %>%   count() %>% .$n,
  )
) %>% mutate(
  acumulado = case_when(
     actividad_consentimientos_owa=="Adultas consentidas HAPIN II" ~ consentimientos_owa %>%  count() %>% .$n,
     actividad_consentimientos_owa=="Adultas que rechazaron HAPIN II" ~ rechazos_adultas_completo_b4  %>%   count() %>% .$n,
  )
) %>% select("Actividad"=actividad_consentimientos_owa, "Quincenal     " = semana, "Acumulado     "=acumulado) %>%

   mutate(Actividad=cell_spec(Actividad,"html", color = "blue",align = "c", bold = T)) %>%
  kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c(" ", "REPORTE CONSENTIMIENTOS ADULTAS B5 HAPIN II, (Denominador 116 Adultas que completaron B4)"=2))

##tabla adultas que no terminaron b4
actividad_consentimientos_owa_nob4<-c("Adultas consentidas HAPIN II",
                                 "Adultas que rechazaron HAPIN II",
                                 "Adultas que No se visitaron HAPIN II"
                                #"Hogares consentidos Sangre seca en B4"
                        )
actividad_consentimientos_owa_nob4<-data.frame(actividad_consentimientos_owa_nob4)
actividad_consentimientos_owa_nob4 %>% mutate(
  semana = case_when(
    actividad_consentimientos_owa_nob4=="Adultas consentidas HAPIN II" ~ "NA",
    actividad_consentimientos_owa_nob4=="Adultas que rechazaron HAPIN II" ~ "NA",
    actividad_consentimientos_owa_nob4=="Adultas que No se visitaron HAPIN II" ~ "NA",
  )
) %>% mutate(
  acumulado = case_when(
     actividad_consentimientos_owa_nob4=="Adultas consentidas HAPIN II" ~ adultas_consentidos_no_b4 %>%  count() %>% .$n,
     actividad_consentimientos_owa_nob4=="Adultas que rechazaron HAPIN II" ~ rechazos_adultas_no_b4  %>%   count() %>% .$n,
     actividad_consentimientos_owa_nob4=="Adultas que No se visitaron HAPIN II" ~ novisitamos_adultas_no_b4  %>%   count() %>% .$n,
  )
) %>% select("Actividad"=actividad_consentimientos_owa_nob4, "Quincenal     " = semana, "Acumulado     "=acumulado) %>%

   mutate(Actividad=cell_spec(Actividad,"html", color = "blue",align = "c", bold = T)) %>%
  kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c(" ", "REPORTE CONSENTIMIENTOS ADULTAS B5 HAPIN II, (Denominador 26 Adultas que No completaron B4)"=2))


```

#### REPORTE AVANCES: "B5 RECLUTAMIENTO/CLINICA"
##### Se inici√≥ esta actividad el 16 de marzo del 2021

```{r B5_CLINICA, echo=FALSE}
#m11 en B5
m11_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(m11_date)) %>% transmute(id, m11_date, evento="b5")
#group_by(evento) %>% summarize(acumulado=n()) %>% spread(key=evento, value = acumulado)
#a23 en B5
a23_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  )  %>% filter(!is.na(a23_date)) %>% transmute(id, a23_date, evento="b5")
#group_by(evento) %>% summarize(acumulado=n()) %>% spread(key=evento, value = acumulado)
#c31 en B5
c31_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(c31_date)) %>% transmute(id, c31_date, evento="b5")
#c33 en B5
c33_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  )  %>% filter(!is.na(c33_date)) %>% transmute(id, c33_date, evento="b5")
#c35 en B5
c35_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(c35_date)) %>% transmute(id, c35_date, evento="b5")
#a24a en B5
a24a_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(a24a_date)) %>% transmute(id, a24a_date, evento="b5")
#a26 en B5
a26a_acumulado_b5<-gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(a26_date)) %>% transmute(id, a26_date, evento="b5")

crf<-c("M11", "C31", "C33","C35", "A23", "A24a","A26a")
reporte_b5_clinica<-data.frame(crf)
reporte_b5_clinica %>% mutate(
  quincenal=case_when(
    crf=="M11" ~ m11_acumulado_b5 %>% filter(m11_date>=fecha1 & m11_date<=fecha2) %>% count() %>% .$n,
    crf=="C31" ~ c31_acumulado_b5 %>% filter(c31_date>=fecha1 & c31_date<=fecha2) %>% count() %>% .$n,
    crf=="C33" ~ c33_acumulado_b5 %>% filter(c33_date>=fecha1 & c33_date<=fecha2) %>% count() %>% .$n,
    crf=="C35" ~ c35_acumulado_b5 %>% filter(c35_date>=fecha1 & c35_date<=fecha2) %>% count() %>% .$n,
    crf=="A23" ~ a23_acumulado_b5 %>% filter(a23_date>=fecha1 & a23_date<=fecha2) %>% count() %>% .$n,
    crf=="A24a" ~ a24a_acumulado_b5 %>% filter(a24a_date>=fecha1 & a24a_date<=fecha2) %>% count() %>% .$n,
    crf=="A26a" ~ a26a_acumulado_b5 %>% filter(a26_date>=fecha1 & a26_date<=fecha2) %>% count() %>% .$n,
    TRUE ~ NA_integer_
  ) ,
  acumulado = case_when(
     crf=="M11" ~ m11_acumulado_b5 %>%  count() %>% .$n,
    crf=="C31" ~ c31_acumulado_b5 %>%  count() %>% .$n,
    crf=="C33" ~ c33_acumulado_b5 %>%  count() %>% .$n,
    crf=="C35" ~ c35_acumulado_b5 %>%  count() %>% .$n,
    crf=="A23" ~ a23_acumulado_b5 %>%  count() %>% .$n,
    crf=="A24a" ~ a24a_acumulado_b5 %>%  count() %>% .$n,
    crf=="A26a" ~ a26a_acumulado_b5 %>%  count() %>% .$n,
    TRUE ~ NA_integer_
  )

)%>%  mutate(crf=case_when(
                                     crf=="M11" ~ "M11 (estilos de vida embarazada)",
                                     crf=="C31" ~ "C31 (estado salud beb√©)",
                                     crf=="C33" ~ "C33 (antropometria)",
                                     crf=="C35" ~ "C35 (Estres materno)",
                                     crf=="A23" ~ "A23 (historia m√©dica adulta)",
                                     crf=="A24a" ~ "A24a (Ma Anthropometria)",
                                     crf=="A26a" ~ "A26a (CIMT)",
                                     TRUE ~ NA_character_
                                   )) %>%
  select("CRF"=crf, "Quincenal     " = quincenal, "Acumulado     "=acumulado) %>%

   mutate(CRF=cell_spec(CRF,"html", color = "blue",align = "c", bold = T)) %>%
  #                                    `En la quincena`= select(., contains("Quincenal")) %>% rowSums(., na.rm = TRUE),
  #                                            `En la quincena`= cell_spec(`En la quincena`, "html", color = "blue", bold=T)
  #                                            ) %>%
  kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c("  ", "REPORTE AVANCES CLINICA B5"=2))

```


#### REPORTE AVANCES: "B5 MEDIDAS/EXPOSICION"
##### Se inici√≥ esta actividad el 16 de marzo del 2021
~~~
Hay 33 hogares que no se les hizo exposici√≥n por tener fecha de visita anterior al 15 de enero del 2021
~~~

```{r B5_EXPOSICION, echo=FALSE}
candidatos_24m<-consentimientos_madre 

#h41 en B5
h41_acumulado_b5<-candidatos_24m %>% select(id, s4_date, s4_consent) %>% left_join( gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(h41_date)) %>% transmute(id, h41_date, evento="b5")
) %>% filter(!is.na(h41_date)) 

#DBS en b5 b10_acumulado_b5
dbs<- candidatos_24m %>% select(id) %>% left_join( gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(b10_tc_spots=="1") %>%  transmute(id, b10_date,b10_tc_spots, evento="b5")
) %>% filter(b10_tc_spots=="1")
# Orina en b5 b10_acumulado_b5
orina<- candidatos_24m %>% select(id) %>% left_join(gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  )  %>% filter(b10_tc_urine=="1") %>%  transmute(id, b10_date,b10_tc_spots,b10_tc_urine, evento="b5")
) %>% filter(b10_tc_urine=="1") 

#medidas directas, indirectas y mixtas  h41_c_beacon_id1  h41_c_ecm_id
medida_mixta<-candidatos_24m %>% select(id) %>% left_join( gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(h41_c_beacon_id1) & h41_c_beacon_id1!="888" & !is.na(h41_c_ecm_id) & h41_c_ecm_id!="888") %>% transmute(id, h41_date, h41_c_beacon_id1,h41_c_ecm_id, evento="b5")
) %>% filter(!is.na(h41_date))

medida_indirecta<-candidatos_24m %>% select(id) %>% left_join( gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1" 
  ) %>% filter(!is.na(h41_c_beacon_id1) & h41_c_beacon_id1!="888" & (is.na(h41_c_ecm_id) | h41_c_ecm_id=="888")) %>% transmute(id, h41_date,h41_c_beacon_id1,h41_c_ecm_id, evento="b5")
) %>% filter(!is.na(h41_date))

medida_directa<- candidatos_24m %>% select(id) %>% left_join(  gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(h41_c_ecm_id) & h41_c_ecm_id!="888" & (is.na(h41_c_beacon_id1) | h41_c_beacon_id1=="888")) %>% transmute(id, h41_date,h41_c_beacon_id1,h41_c_ecm_id, evento="b5")
) %>% filter(!is.na(h41_date)) 


#h57 en B5
h57_acumulado_b5<- candidatos_24m %>% left_join(
  bind_rows(
    rechazos_33,
    rechazos_35
  )
  
) %>% left_join( gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(h57_date)) %>% transmute(id, h57_date, evento="b5")
) %>% filter(!is.na(h57_date))

#b10 en b5
a24b_acumulado_b5<- gt_hapin_II_data %>% filter(
    redcap_event_name=="24_month_arm_1"
  ) %>% filter(!is.na(a24b_date)) %>% transmute(id, a24b_date, evento="b5")

crf<-c("H41","--DBS","--ORINA", "--MEDIDA DIRECTA","--MEDIDA INDIRECTA","--MEDIDA MIXTA", "A24b", "H57")
reporte_b5_exposicion<-data.frame(crf)
reporte_b5_exposicion %>% mutate(
  quincenal=case_when(

    crf=="H41" ~ h41_acumulado_b5 %>% filter(h41_date>=fecha1 & h41_date<=fecha2) %>% count() %>% .$n,
     crf=="--DBS" ~ dbs %>% filter(b10_date>=fecha1 & b10_date<=fecha2) %>% count() %>% .$n,
    crf=="--ORINA" ~ orina %>% filter(b10_date>=fecha1 & b10_date<=fecha2) %>% count() %>% .$n,
    crf=="--MEDIDA DIRECTA" ~ medida_directa %>% filter(h41_date>=fecha1 & h41_date<=fecha2) %>% count() %>% .$n,
    crf=="--MEDIDA INDIRECTA" ~ medida_indirecta %>% filter(h41_date>=fecha1 & h41_date<=fecha2) %>% count() %>% .$n,
    crf=="--MEDIDA MIXTA" ~ medida_mixta %>% filter(h41_date>=fecha1 & h41_date<=fecha2) %>% count() %>% .$n,
    crf=="A24b" ~ a24b_acumulado_b5 %>% filter(a24b_date>=fecha1 & a24b_date<=fecha2) %>% count() %>% .$n,
    crf=="H57" ~ h57_acumulado_b5 %>% filter(h57_date>=fecha1 & h57_date<=fecha2) %>% count() %>% .$n,
    TRUE ~ NA_integer_
  ),
  acumulado=case_when(
    crf=="H41" ~ h41_acumulado_b5  %>% count() %>% .$n,
    crf=="--DBS" ~ dbs %>%  count() %>% .$n,
    crf=="--ORINA" ~ orina %>%  count() %>% .$n,
    crf=="--MEDIDA DIRECTA" ~ medida_directa %>%  count() %>% .$n,
    crf=="--MEDIDA INDIRECTA" ~ medida_indirecta %>%  count() %>% .$n,
    crf=="--MEDIDA MIXTA" ~ medida_mixta %>%  count() %>% .$n,
    crf=="A24b" ~ a24b_acumulado_b5  %>% count() %>% .$n,
    crf=="H57" ~ h57_acumulado_b5  %>% count() %>% .$n,
    TRUE ~ NA_integer_
  )
) %>% mutate(crf=case_when(

                                     crf=="H41" ~ "H41 (Equipo De Exposicion)",
                                     crf=="--DBS" ~ "--DBS",
                                     crf=="--ORINA" ~ "--ORINA",
                               crf=="--MEDIDA DIRECTA" ~ "--MEDIDA DIRECTA (ECM)",
                               crf=="--MEDIDA INDIRECTA" ~ "--MEDIDA INDIRECTA (Beacon)",
                               crf=="--MEDIDA MIXTA" ~ "--MEDIDA MIXTA (ECM y Beacon)",
                                     crf=="A24b" ~ "A24b (Ma Presion Arterial)",
                                     crf=="H57" ~ "H57 (Encuesta Inicial)",
                                     TRUE ~ NA_character_
                                   )) %>%
  select("CRF"=crf, "Quincenal     " = quincenal, "Acumulado     "=acumulado) %>%

   mutate(CRF=cell_spec(CRF,"html", color = "blue",align = "c", bold = T)) %>%
  #                                    `En la quincena`= select(., contains("Quincenal")) %>% rowSums(., na.rm = TRUE),
  #                                            `En la quincena`= cell_spec(`En la quincena`, "html", color = "blue", bold=T)
  #                                            ) %>%
  kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c("  ", "REPORTE AVANCES EXPOSICION B5"=2))


#revisi√≥n crfs faltantes


```
## HAPIN 36 MESES AVANCES
#### CONTEOS: "HAPIN-II  B6"
##### Inicio de actividad: el 22 de febrero del 2022


```{r consentimientos_hapinII_b6, echo=FALSE}
# consentimientos_hapinII<-gt_hapin_II_data %>% group_by(id,s4_consent, s4_consent_c, s4_owa ) %>% count()

#esperados en 36 meses a la fecha del reporte
candidatos_36m<-gt_emory_data_arm2 %>% filter(!is.na(c30_dob)) %>% select(id, c30_dob) %>% mutate(
  ventana=as.Date(c30_dob) + lubridate::days(330),
  un_anio=as.Date(c30_dob) + lubridate::days(365)
) %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_c)) %>% select(id, e3_date_exit_c, e3_reason_c)
) %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_exit)) %>% select(id, e3_date_exit, e3_reason)
) %>% mutate(
  descartar=case_when(
    e3_reason=="8"  ~  "Si",
    TRUE ~ "No"
  )
) %>% filter(descartar=="No") %>% select(id, fecha_nacimiento=c30_dob) %>% mutate(
  `12_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*12)),
  `24_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*24)),
  `36_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*36)),
  `48_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*48)),
  `60_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*60))
) %>% select(id, fecha_36m=`36_meses`)

candidatos_36m<-candidatos_36m %>% filter(as.Date(fecha_36m)<=fecha2)
#E3 en B6
e3_acumulado_b6<-gt_hapin_II_data %>% filter(
  redcap_event_name=="year_3_q1_36m_arm_1"
) %>% filter(!is.na(e3_date)) %>% transmute(id, e3_date, evento="b6")

#conteo consentimientos hapin II 36 meses 
#marcar los consentidos y rechazadas
 consentimientos_36m<-   gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% select(
      s4_date, s4_consent_c
    ) %>% mutate(
      consentidos=if_else(s4_consent_c=="1", "1", NA_character_),
      rechazado=if_else(s4_consent_c=="0","1", NA_character_)
    )
    
    #armar la tabla de consentimientos 36m
actividad_consentimientos<-c( "Esperados",
                              "S4 realizados",
                              "--Consentidos",
                              "--Rechazados",
                               "Salidas"
                              
                              
                        ) 

consentimientos_36m_15nal<-consentimientos_36m %>% filter(s4_date>=fecha1 & s4_date<=fecha2)

reporte_consentimientos_36m<-data.frame(Actividad=actividad_consentimientos) 
reporte_consentimientos_36m %>% mutate(
  Quincenal = case_when(
    Actividad =="Esperados" ~  candidatos_36m %>% filter(
      as.Date(fecha_36m)>=fecha1 & as.Date(fecha_36m)<=fecha2 
    ) %>%  count() %>% .$n,
    Actividad =="--Consentidos" ~  consentimientos_36m_15nal %>% filter(consentidos=="1") %>%  count() %>% .$n,
    Actividad=="--Rechazados" ~ consentimientos_36m_15nal %>% filter(rechazado == "1") %>% 
      count() %>% .$n,
    Actividad=="S4 realizados" ~ consentimientos_36m_15nal %>% filter(!is.na(s4_date)) %>% count() %>% .$n,
    Actividad=="Salidas" ~ e3_acumulado_b6 %>% filter(e3_date>=fecha1 & e3_date<=fecha2) %>% count() %>% .$n,
    TRUE ~ NA_integer_
    
  ),
  Acumulado= case_when(
    Actividad =="Esperados" ~  candidatos_36m %>% count() %>% .$n,
     Actividad =="--Consentidos" ~  consentimientos_36m %>% filter(consentidos=="1") %>%  count() %>% .$n,
    Actividad=="--Rechazados" ~ consentimientos_36m %>% filter(rechazado == "1") %>% 
      count() %>% .$n,
    Actividad=="S4 realizados" ~ consentimientos_36m %>% filter(!is.na(s4_date)) %>% count() %>% .$n,
    Actividad=="Salidas" ~ e3_acumulado_b6 %>%  count() %>% .$n,
    TRUE ~ NA_integer_
  )
) %>%   mutate(Actividad=cell_spec(Actividad,"html", color = "blue",align = "c", bold = T)) %>%
 kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c(" ", "REPORTE VISITAS HAPIN II 36m"=2))

var_candidatos<-candidatos_36m %>% count() %>% .$n
var_realizados <-consentimientos_36m %>% filter(!is.na(s4_date)) %>% count() %>% .$n

```
~~~~
Resumen:
Visitas esperadas a la fecha: "`r candidatos_36m %>% count() %>% .$n `" (Segun cumple a√±os)
Visitas realizadas a la fecha: "`r consentimientos_36m %>% filter(!is.na(s4_date)) %>% count() %>% .$n `"
Proporci√≥n de realizadas sobre esperadas: `r percent(var_realizados / var_candidatos)`

~~~~


#### RECLUTAMIENTO Y CUESTIONARIOS
##### Inicio de actividad: el 22 de febrero del 2022

```{r B6_CLINICA, echo=FALSE}
#m10 en B6
m10_acumulado_b6<-gt_hapin_II_data %>% filter(
  redcap_event_name=="year_3_q1_36m_arm_1"
) %>% filter(!is.na(m10_date)) %>% filter(id!='99999') %>% transmute(id, m10_date, evento="b6")
#m11 en B6
m11_acumulado_b6<-gt_hapin_II_data %>% filter(
    redcap_event_name=="year_3_q1_36m_arm_1"
  ) %>% filter(!is.na(m11_date)) %>% filter(id!='99999') %>% transmute(id, m11_date, evento="b6")
#group_by(evento) %>% summarize(acumulado=n()) %>% spread(key=evento, value = acumulado)
#m19 en B6
m19_acumulado_b6<-gt_hapin_II_data %>% filter(
  redcap_event_name=="year_3_q1_36m_arm_1"
) %>% filter(!is.na(m19_date)) %>% filter(id!='99999') %>% transmute(id, m19_date, evento="b6")

#c31 en B6
c31_acumulado_b6<-gt_hapin_II_data %>% filter(
    redcap_event_name=="year_3_q1_36m_arm_1"
  ) %>% filter(!is.na(c31_date_2)) %>% transmute(id, c31_date_2, evento="b6")

#c32 en B6
c32_acumulado_b6<-gt_hapin_II_data %>% filter(
    redcap_event_name=="year_3_q1_36m_arm_1"
  ) %>% filter(!is.na(c32_date_2)) %>% transmute(id, c32_date_2, evento="b6")


#c35 en B6
c35_acumulado_b6<-gt_hapin_II_data %>% filter(
    redcap_event_name=="year_3_q1_36m_arm_1"
  ) %>% filter(!is.na(c35_date_2)) %>% transmute(id, c35_date_2, evento="b6")

#c42 en B6
c42_acumulado_b6<-gt_hapin_II_data %>% filter(
    redcap_event_name=="year_3_q1_36m_arm_1"
  ) %>% filter(!is.na(c42_date)) %>% transmute(id, c42_date, evento="b6")


#H57 en B6
h57_acumulado_b6<- gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>%  transmute(id, h57_date_2,evento="b6") %>% filter(
  !is.na(h57_date_2)
)

#C85 Mdat
c85_acumulado_b6<-gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% transmute(
  id, c85_date, evento="b6"
) %>% filter(
  !is.na(c85_date)
)

crf<-c("M10","M11", "M19", "C31", "C32","C35", "C42", "H57", "C85")
reporte_b6_clinica<-data.frame(crf)
reporte_b6_clinica %>% mutate(
  quincenal=case_when(
    crf=="M10" ~ m10_acumulado_b6 %>% filter(m10_date>=fecha1 & m10_date<=fecha2) %>% count() %>% .$n,
    crf=="M11" ~ m11_acumulado_b6 %>% filter(m11_date>=fecha1 & m11_date<=fecha2) %>% count() %>% .$n,
    crf=="M19" ~ m19_acumulado_b6 %>% filter(m19_date>=fecha1 & m19_date<=fecha2) %>% count() %>% .$n,
    crf=="C31" ~ c31_acumulado_b6 %>% filter(c31_date_2>=fecha1 & c31_date_2<=fecha2) %>% count() %>% .$n,
    crf=="C32" ~ c32_acumulado_b6 %>% filter(c32_date_2>=fecha1 & c32_date_2<=fecha2) %>% count() %>% .$n,
    crf=="C35" ~ c35_acumulado_b6 %>% filter(c35_date_2>=fecha1 & c35_date_2<=fecha2) %>% count() %>% .$n,
    crf=="C42" ~ c42_acumulado_b6 %>% filter(c42_date>=fecha1 & c42_date<=fecha2) %>% count() %>% .$n,
    crf=="H57" ~ h57_acumulado_b6 %>% filter(h57_date_2>=fecha1 & h57_date_2<=fecha2) %>% count() %>% .$n,
    crf=="C85" ~ c85_acumulado_b6 %>% filter(c85_date>=fecha1 & c85_date<=fecha2) %>% count() %>% .$n,
    TRUE ~ NA_integer_
  ) ,
  acumulado = case_when(
    
    crf=="M10" ~ m10_acumulado_b6 %>% count() %>% .$n,
    crf=="M11" ~ m11_acumulado_b6 %>%  count() %>% .$n,
    crf=="M19" ~ m19_acumulado_b6 %>%  count() %>% .$n,
    crf=="C31" ~ c31_acumulado_b6 %>%  count() %>% .$n,
    crf=="C32" ~ c32_acumulado_b6 %>%  count() %>% .$n,
    crf=="C35" ~ c35_acumulado_b6 %>%  count() %>% .$n,
    crf=="C42" ~ c42_acumulado_b6 %>%  count() %>% .$n,
    crf=="H57" ~ h57_acumulado_b6 %>%  count() %>% .$n,
    crf=="C85" ~ c85_acumulado_b6 %>%  count() %>% .$n,

    TRUE ~ NA_integer_
  )

)%>%  mutate(crf=case_when(
  crf=="M10" ~ "M10 Demografico",                                   
  crf=="M11" ~ "M11 Comportamiento sobre Estilo de Vida",
  crf=="M19" ~ "M19 Costos e ingresos",
                                     crf=="C31" ~ "C31 (estado salud beb√©)",
                                     crf=="C32" ~ "C32 Alimentaci√≥n II",
                                     crf=="C35" ~ "C35 Salud Mental II",
   crf=="C42" ~ "C42 Vacunacion",
   crf=="H57" ~ "H57 Encuesta inicial II",
    crf=="C85" ~ "C85 MDAT",
                                    
                                     TRUE ~ NA_character_
                                   )) %>%
  select("CRF"=crf, "Quincenal     " = quincenal, "Acumulado     "=acumulado) %>%

   mutate(CRF=cell_spec(CRF,"html", color = "blue",align = "c", bold = T)) %>%
  #                                    `En la quincena`= select(., contains("Quincenal")) %>% rowSums(., na.rm = TRUE),
  #                                            `En la quincena`= cell_spec(`En la quincena`, "html", color = "blue", bold=T)
  #                                            ) %>%
  kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c("  ", "REPORTE AVANCES CRF'S RECLUTAMIENTO B6"=2))



```

#### CUESTIONARIOS DE MEDICIONES
##### Inicio de actividad: el 24 de febrero del 2022

```{r B6_EXPOSICION, echo=FALSE}


#-------------------
# EXPOSICION B6
CRF<-c("M14a", "M14b", "C33", "H41","H42", "H43", "C86")
reporte_b6_exposicion<-data.frame(CRF)

#m14a en B6
m14a_acumulado_b6<-gt_hapin_II_data %>% filter(
  redcap_event_name=="year_3_q1_36m_arm_1"
) %>% filter(!is.na(m14a_date )) %>% filter(id!='99999') %>% transmute(id, m14a_date, evento="b6")

#m14b en B6
m14b_acumulado_b6<-gt_hapin_II_data %>% filter(
  redcap_event_name=="year_3_q1_36m_arm_1"
) %>% filter(!is.na(m14b_date )) %>% filter(id!='99999') %>% transmute(id, m14b_date, evento="b6")


#c33 en B6
c33_acumulado_b6<-gt_hapin_II_data %>% filter(
    redcap_event_name=="year_3_q1_36m_arm_1"
  )  %>% filter(!is.na(c33_date_2)) %>% transmute(id, c33_date_2, evento="b6")

#h41
H41<-gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% select(id, h41_date_v2) %>% filter(
  !is.na(h41_date_v2)
)

#h42
H42<-gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% select(id, h42_date_2) %>% filter(
  !is.na(h42_date_2)
)

#h43
H43<-gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% select(id, h43_date_2) %>% filter(
  !is.na(h43_date_2)
)

#C85 FOT
C86<-gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% select(
  id, c86_date
) %>% filter(!is.na(c86_date))

reporte_b6_exposicion %>% mutate(
  Quincenal=case_when(
    CRF=="M14a" ~ m14a_acumulado_b6 %>% filter(m14a_date>=fecha1 & m14a_date<=fecha2) %>% count() %>% .$n,
    CRF=="M14b" ~ m14b_acumulado_b6 %>% filter(m14b_date>=fecha1 & m14b_date<=fecha2) %>% count() %>% .$n,
    CRF=="C33" ~ c33_acumulado_b6 %>% filter(c33_date_2>=fecha1 & c33_date_2<=fecha2) %>% count() %>% .$n,
    CRF=="H41" ~ H41 %>% filter(h41_date_v2>=fecha1 & h41_date_v2<=fecha2) %>% count() %>% .$n,
    CRF=="H42" ~ H42 %>% filter(h42_date_2>=fecha1 & h42_date_2<=fecha2) %>% count() %>% .$n,
    CRF=="H43" ~ H43 %>% filter(h43_date_2>=fecha1 & h43_date_2<=fecha2) %>% count() %>% .$n,
    CRF=="C86" ~ C86 %>% filter(c86_date>=fecha1 & c86_date<=fecha2) %>% count() %>% .$n,
    TRUE ~ NA_integer_
  ),
   Acumulado=case_when(
    CRF=="M14a" ~ m14a_acumulado_b6 %>% count() %>% .$n,
    CRF=="M14b" ~ m14b_acumulado_b6 %>% count() %>% .$n,
    CRF=="C33" ~ c33_acumulado_b6 %>% count() %>% .$n,
    CRF=="H41" ~ H41 %>%  count() %>% .$n,
    CRF=="H42" ~ H42 %>%  count() %>% .$n,
    CRF=="H43" ~ H43 %>%  count() %>% .$n,
    CRF=="C86" ~ C86 %>%  count() %>% .$n,
    TRUE ~ NA_integer_
  )
) %>%   mutate(CRF=case_when(
                        CRF=="M14a" ~ "M14a Antropometria",                                   
                        CRF=="M14b" ~ "M14b Presion Arterial",
                        CRF=="C33" ~ "C33 Antropometria Infantil",
                        CRF=="H41" ~ "H41 Equipo Exposici√≥n II",
                        CRF=="H42" ~ "H42 Exposure Compliance II",
                        CRF=="H43" ~ "H43 Linea Basal de Exposici√≥n II",
                        CRF=="C86" ~ "C86 FOT",
                                     TRUE ~ NA_character_
                                   )) %>%
  select("CRF"=CRF, "Quincenal     " = Quincenal, "Acumulado     "=Acumulado) %>%
 mutate(CRF=cell_spec(CRF,"html", color = "blue",align = "c", bold = T)) %>%
    kable(caption = paste(""), escape = F) %>%
  kable_styling("hover", full_width = F) %>%
  column_spec(2, width = "5cm", color = "blue", bold = T) %>%
  add_header_above(c("  ", "REPORTE AVANCES CRF'S MEDIDAS EXPOSICION B6"=2)) 
```


~~~~
 *Quincena del  "`r as.Date(f_week1) %>% format(.,"%A %d %B  %Y")`" al "`r as.Date(f_week2) %>% format(.,"%A %d %B  %Y")` "*
~~~~


## HAPIN 36 MESES INDICADORES
#### HOGARES PROGRAMADOS POR MES: "HAPIN-II  B6"
```{r avance_anual, echo=FALSE}

#esperados en 36 meses a la fecha del reporte
esperados_36meses<-gt_emory_data_arm2 %>% filter(!is.na(c30_dob)) %>% select(id, c30_dob) %>% mutate(
  ventana=as.Date(c30_dob) + lubridate::days(330),
  un_anio=as.Date(c30_dob) + lubridate::days(365)
) %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_c)) %>% select(id, e3_date_exit_c, e3_reason_c)
) %>% left_join(
  gt_emory_data_arm2 %>% filter(!is.na(e3_date_exit)) %>% select(id, e3_date_exit, e3_reason)
) %>% mutate(
  descartar=case_when(
    e3_reason=="8"  ~  "Si",
    TRUE ~ "No"
  )
) %>% filter(descartar=="No") %>% select(id, fecha_nacimiento=c30_dob) %>% mutate(
  `12_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*12)),
  `24_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*24)),
  `36_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*36)),
  `48_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*48)),
  `60_meses`= as.Date(fecha_nacimiento) + lubridate::days(round(30.25*60))
) %>% select(id, fecha_36m=`36_meses`)

dt_esperados_36m<-esperados_36meses %>%  mutate( Mes=format(fecha_36m, "%B")) %>% group_by(
  Anio=lubridate::year(fecha_36m),
  mes=lubridate::month(fecha_36m),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, Esperados=n) 

#realizados que tienen s4 por mes
dt_realizados_36m<-consentimientos_36m %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, Realizados=n)

#Consentidos por mes
dt_consentidos_36m<-consentimientos_36m %>% filter(!is.na(consentidos)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, Consentidos=n)

#rechazados por mes
dt_rechazados_36m<-consentimientos_36m %>% filter(!is.na(rechazado)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, `No consintieron`=n)

#migraciones
dt_migraciones_36m<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(visit=="b6") %>%  select(id, s4_date, s4_reason_c) %>% filter(!is.na(s4_reason_c)) %>% mutate(
  razon=toupper(s4_reason_c),
  migracion=case_when(
    grepl("FUERA DEL AREA DEL ESTUDIO", razon) ~ "1",
    grepl("FUERA DEL AREA DE ESTUDIO", razon) ~ "1",
    grepl("AREA DEL ESTUDIO", razon) ~ "1",
    grepl("AREA DE ESTUDIO", razon) ~ "1",
    grepl("MIGRO", razon) ~ "1",
    grepl("MIGR√ì", razon) ~ "1",
    grepl("SE MUDO", razon) ~ "1",
    grepl("FUERA DEL √ÅREA", razon) ~ "1",
    grepl("FUERA DEL ESTUDIO", razon) ~ "1",
    grepl("MIGRACI√ìN", razon) ~ "1",
    grepl("MIGRACION", razon) ~ "1",
    grepl("MIGRARON", razon) ~ "1",
    grepl("DE VIAJE", razon) ~ "1",
     grepl("MUDARON", razon) ~ "1",
    
    TRUE ~ NA_character_
  )
) %>% filter(!is.na(migracion)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, Migraciones=n)
#codigo anterior a las modificaciones solicitadas por Anaite ----
# dt_esperados_36m %>% left_join(
#   dt_realizados_36m %>% mutate(
#     acumulado_realizados = cumsum(as.numeric(Realizados))
#     
#   )
# ) %>% mutate(
#   acumulado_esperados=cumsum(as.numeric(Esperados))
# ) %>% 
#   mutate(
#   p_realizados=percent(as.numeric(acumulado_realizados) / as.numeric(acumulado_esperados), 1)
# ) %>% left_join(
#   dt_consentidos_36m
# ) %>% mutate(
#   p_consentidos=percent(as.numeric(Consentidos) / as.numeric(Realizados), 1)
# ) %>% left_join(
#   dt_rechazados_36m
# ) %>% mutate(
#   p_noconsentidos=percent(as.numeric(`No consintieron`) / as.numeric(Realizados), 1)
# ) %>% left_join(
#   dt_migraciones_36m
# ) %>% mutate(
#   p_migraciones=percent(as.numeric( Migraciones) / as.numeric(`No consintieron`), 1)
# ) %>% transmute(
#   `A√±o`=Anio,
#   Mes=toupper(Mes),
#   `Programados por mes`=Esperados,
#   `Realizados por mes`= if_else(is.na(Realizados), NA_character_, as.character(Realizados )),
#   `Acumulado Realizado por mes(%)`= if_else(is.na(Realizados), NA_character_, paste0(as.character(acumulado_realizados)," (",as.character(p_realizados),")")
#                                             ),
#   `Consintieron(%)`=if_else(is.na(Consentidos), NA_character_, paste0(Consentidos," (", p_consentidos, ")")),
#   `No consintieron(%)`= if_else(is.na(`No consintieron`), NA_character_, paste0(`No consintieron`," (",p_noconsentidos, ")")),
#   `Migraciones(%)`=if_else(is.na(Migraciones), NA_character_, paste0(Migraciones," (",p_migraciones,")"))
# ) %>% kable(caption = "<center>REPORTE MENSUAL <br>
#                   DE AVANCES</center>", 
#         align = "l") %>% 
#     kable_classic(full_width=F, html_font = "Cambria")

#integrar tabla programados por mes, con modificaciones ----
dt_esperados_36m %>% left_join(
  dt_realizados_36m %>% mutate(
    acumulado_realizados = cumsum(as.numeric(Realizados))
    
  )
) %>% mutate(
  acumulado_esperados=cumsum(as.numeric(Esperados))
) %>% 
  mutate(
  p_realizados=percent(as.numeric(acumulado_realizados) / as.numeric(acumulado_esperados), 1)
) %>% left_join(
  dt_consentidos_36m %>% mutate(
    acumulado_consentidos=cumsum(as.numeric(Consentidos))
  )
) %>% mutate(
  p_consentidos=percent(as.numeric(Consentidos) / as.numeric(Realizados), 1),
) %>% transmute(
  `A√±o`=Anio,
  Mes=toupper(Mes),
  `Programados`=Esperados,
  `Acumulado Programados` = paste0(acumulado_esperados, " (", percent(acumulado_esperados/750,1),")"),
  `Visitados`= if_else(is.na(Realizados), NA_character_, as.character(Realizados )),
  `Acumulado Visitados(%)`= if_else(is.na(Realizados), NA_character_, paste0(as.character(acumulado_realizados)," (",as.character(p_realizados),")")
                                            ),
  `Consintieron(%)`=if_else(is.na(Consentidos), NA_character_, paste0(Consentidos," (", p_consentidos, ")")),
  `Acumulados Consintieron(%)`=if_else(is.na(Consentidos), NA_character_, paste0(acumulado_consentidos, " (", percent(acumulado_consentidos/acumulado_realizados),")") )

)%>% kable(caption = "<center>REPORTE MENSUAL <br>
                  DE AVANCES</center>", 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria")


```


#### RECLUTAMIENTOS Y MEDIDAS: "HAPIN-II  B6"

```{r avance_cat_quincenal, echo=FALSE}
dt_c31_h41_categorias<-gt_hapin_II_data %>% filter(!is.na(c31_date_2)) %>% select(id, c31_date_2) %>% left_join(
  esperados_36meses
) %>% left_join(
  gt_hapin_II_data %>% filter(!is.na(h41_date_v2)) %>% select(id, h41_date_v2)
) %>% mutate(
  dias_c31_esperado=as.numeric(as.Date(c31_date_2) - as.Date(fecha_36m)),
  dias_h41_esperado=as.numeric(as.Date(h41_date_v2) - as.Date(fecha_36m)),
  Categoria_c31= case_when(
    dias_c31_esperado<= 30 ~ "<=30",
    dias_c31_esperado>30 & dias_c31_esperado<=90 ~ "31-90",
    dias_c31_esperado>90 ~ ">90",
  ),
  Categoria_h41= case_when(
    dias_h41_esperado<= 30 ~ "<=30",
    dias_h41_esperado>30 & dias_h41_esperado<=90 ~ "31-90",
    dias_h41_esperado>90 ~ ">90",
  ),
   Mes=toupper( format(c31_date_2, "%B") )

) 



cat_quincenal<-dt_c31_h41_categorias %>% filter(c31_date_2>=f_week1) %>% group_by(Categoria_c31) %>% count() %>% ungroup() %>% select(categoria=Categoria_c31, cantidad_c31=n) %>% full_join(
  dt_c31_h41_categorias %>% filter(h41_date_v2>=f_week1) %>% group_by(Categoria_h41) %>% count() %>% ungroup() %>% select(categoria=Categoria_h41, cantidad_h41=n)
)

   

dt_elaborados_quincenal<-c( "<=30",
              "31 - 90",
               "> 90"
              ) %>% data.frame(Categorias=.) 

#verifiar siempre el c√≥digo para mayores a 90 dias c31 y h41
# var_91_1<-cat_quincenal %>% filter(categoria==">90") %>% select(cantidad_c31) %>% .$cantidad_c31

dt_avances_quincenal<-dt_elaborados_quincenal %>% mutate(
  `Quincenal`=case_when(
    Categorias=="<=30" ~ cat_quincenal %>% filter(categoria=="<=30") %>% select(cantidad_c31) %>% .$cantidad_c31,
     Categorias=="31 - 90" ~ cat_quincenal %>% filter(categoria=="31-90") %>% select(cantidad_c31) %>% .$cantidad_c31
 # Categorias=="> 90" ~  cat_quincenal %>% filter(categoria==">90") %>% select(cantidad_c31) %>% .$cantidad_c31
),
`Acumulado`=case_when(
  Categorias=="<=30" ~ dt_c31_h41_categorias %>% filter(Categoria_c31=="<=30") %>%  group_by() %>% count() %>% .$n,
   Categorias=="31 - 90" ~ dt_c31_h41_categorias %>% filter(Categoria_c31=="31-90") %>%  group_by() %>% count() %>% .$n,
  Categorias=="> 90" ~ dt_c31_h41_categorias %>% filter(Categoria_c31==">90") %>%  group_by() %>% count() %>% .$n
),
` Quincenal `=case_when(
    Categorias=="<=30" ~ cat_quincenal %>% filter(categoria=="<=30") %>% select(cantidad_h41) %>% .$cantidad_h41,
     Categorias=="31 - 90" ~ cat_quincenal %>% filter(categoria=="31-90") %>% select(cantidad_h41) %>% .$cantidad_h41
    # Categorias=="> 90" ~ cat_quincenal %>% filter(categoria==">90") %>% select(cantidad_h41) %>% .$cantidad_h41
),
` Acumulado `=case_when(
  Categorias=="<=30" ~ dt_c31_h41_categorias %>% filter(Categoria_h41=="<=30") %>%  group_by() %>% count() %>% .$n,
   Categorias=="31 - 90" ~ dt_c31_h41_categorias %>% filter(Categoria_h41=="31-90") %>%  group_by() %>% count() %>% .$n,
  Categorias=="> 90" ~ dt_c31_h41_categorias %>% filter(Categoria_h41==">90") %>%  group_by() %>% count() %>% .$n
)
) 
dt_avances_quincenal_total<-dt_avances_quincenal %>% bind_rows(
 apply(X= dt_avances_quincenal %>% transmute(Acumulado=as.numeric(Acumulado), ` Acumulado `=as.numeric(` Acumulado `)), MARGIN=2, FUN= sum) 
)

dt_avances_quincenal_integrado<-dt_avances_quincenal_total %>% mutate(
 Categorias= if_else(is.na(Categorias), "Total",Categorias)
) 
 totales<-dt_avances_quincenal_integrado %>% filter(Categorias=="Total") %>% select(Total_c31=Acumulado, Total_h41=` Acumulado `)

 dt_avances_final<-dt_avances_quincenal_integrado %>% mutate(
   p_c31=case_when(
     Categorias!="Total" ~ percent(as.numeric(Acumulado) / totales$Total_c31)
   ),
   p_h41=case_when(
     Categorias!="Total" ~ percent(as.numeric(` Acumulado `) / totales$Total_h41 )
   )
 ) %>% transmute(
   Categorias, Quincenal, Acumulado= paste0(Acumulado, " (", p_c31,")"),
   ` Quincenal `, 
   ` Acumulado `=paste0(` Acumulado `," (", p_h41,")")
 )

dt_avances_final %>% mutate(
  Acumulado=if_else(
    Categorias=="Total", substr(Acumulado,1,3), Acumulado
  ),
   ` Acumulado `=if_else(
    Categorias=="Total", substr(` Acumulado `,1,3), ` Acumulado `
  )
) %>% 
kable(caption = "<center>REPORTE CONSENTIDOS Y MEDIDAS<br>
                  QUINCENAL Y ACUMULADO </center>", 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria") %>% column_spec(2, width = "2cm",  bold = T) %>% column_spec(3, width = "5cm",  bold = F)  %>% column_spec(4, width = "2cm",  bold = T)   %>% column_spec(5, width = "5cm",  bold = F)   %>% row_spec(1, bold=F, background = "#11e88d") %>% row_spec(2, bold=F, background = "#edcc46") %>% row_spec(3, bold=F, background =  "#df455c") %>% row_spec(4, bold=T) %>% 
 add_header_above(c("    ", "CONSENTIDOS (C31) "=2, "MEDIDAS (H41) "=2 ))

#dt_c31_h41_categorias %>% writexl::write_xlsx("output/revision_rojos.xlsx")

```

#### RECHAZOS POR MES: "HAPIN-II  B6"

```{r avance_rechazos, echo=FALSE}
#Consentidos por mes
dt_consentidos_36m<-consentimientos_36m %>% filter(!is.na(consentidos)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, Consentidos=n)

#rechazados por mes
dt_rechazados_36m<-consentimientos_36m %>% filter(!is.na(rechazado)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, `No consintieron`=n)

#migraciones
dt_migraciones_36m<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(visit=="b6") %>%  select(id, s4_date, s4_reason_c) %>% filter(!is.na(s4_reason_c)) %>% mutate(
  razon=toupper(s4_reason_c),
  migracion=case_when(
    grepl("FUERA DEL AREA DEL ESTUDIO", razon) ~ "1",
    grepl("FUERA DEL AREA DE ESTUDIO", razon) ~ "1",
    grepl("AREA DEL ESTUDIO", razon) ~ "1",
    grepl("AREA DE ESTUDIO", razon) ~ "1",
    grepl("MIGRO", razon) ~ "1",
    grepl("MIGR√ì", razon) ~ "1",
    grepl("SE MUDO", razon) ~ "1",
    grepl("FUERA DEL √ÅREA", razon) ~ "1",
    grepl("FUERA DEL ESTUDIO", razon) ~ "1",
    grepl("MIGRACI√ìN", razon) ~ "1",
    grepl("MIGRACION", razon) ~ "1",
    grepl("MIGRARON", razon) ~ "1",
    grepl("DE VIAJE", razon) ~ "1",
     grepl("MUDARON", razon) ~ "1",
    
    TRUE ~ NA_character_
  )
) %>% filter(!is.na(migracion)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, Migraciones=n)

dt_rechazos_motivos<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(visit=="b6") %>% select(
  id, s4_date, s4_consent_c, s4_reason_c
) %>% filter(s4_consent_c=="0") %>% left_join(
  gt_hapin_II_data %>% filter(!is.na(e3_date)) %>% filter(visit=="b6") %>%  select(id, e3_reason)
) %>% mutate(
  motivo_rechazo=recode(e3_reason,
                        "3"="Retiro voluntario",
                        "4"="Retirada por el equipo de estudio",
                        "5"="Se mud√≥ del √°rea de estudio",
                        "6"="Muerte de la madre",
                        "7"="Muerte Infantil",
                        "8"="Fuera de la ventana",
                        "555"="Otro")
)  %>% mutate(
  razon=toupper(s4_reason_c),
  migracion=case_when(
    grepl("FUERA DEL AREA DEL ESTUDIO", razon) ~ "1",
    grepl("FUERA DEL AREA DE ESTUDIO", razon) ~ "1",
    grepl("AREA DEL ESTUDIO", razon) ~ "1",
    grepl("AREA DE ESTUDIO", razon) ~ "1",
    grepl("MIGRO", razon) ~ "1",
    grepl("MIGR√ì", razon) ~ "1",
    grepl("SE MUDO", razon) ~ "1",
    grepl("FUERA DEL √ÅREA", razon) ~ "1",
    grepl("FUERA DEL ESTUDIO", razon) ~ "1",
    grepl("MIGRACI√ìN", razon) ~ "1",
    grepl("MIGRACION", razon) ~ "1",
    grepl("MIGRARON", razon) ~ "1",
    grepl("DE VIAJE", razon) ~ "1",
     grepl("MUDARON", razon) ~ "1",
    
    TRUE ~ NA_character_
  ),
  no_autoriza_padre_familiar=case_when(
   grepl("PADRE ", razon) ~ "1", 
   grepl("PERMISO", razon) ~ "1", 
   grepl("ESPOSO", razon) ~ "1", 
    grepl("FAMILIARES NO", razon) ~ "1",
    grepl("FAMILIARES QUE", razon) ~ "1",
    grepl("FAMILIAR QUIEN", razon) ~ "1",
    grepl("FAMILIAR NO ESTA", razon) ~ "1"
  ),
  falta_valor_al_estudio=case_when(
   grepl("LOS CAMBIOS ", razon) ~ "1",
   grepl("CAMBIOS EN EL PROYECTOS ", razon) ~ "1",
   grepl("CAMBIOS EN EL PROYECTOS", razon) ~ "1",
   grepl("NO LE INTERESA SEGUIR CON CAMBIOS EN EL PROYECTO", razon) ~ "1",
  ),
  no_tiene_tiempo=case_when(
    grepl("NO TIENE TIEMPO", razon) ~ "1"
  )
)


dt_consentidos_36m %>% left_join(
  dt_rechazados_36m
) %>% mutate(
    p_no_consintieron= percent(as.numeric(`No consintieron`)/ as.numeric(Consentidos),1)
)%>% left_join(
  dt_rechazos_motivos %>% filter(!is.na(migracion)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, 
                                           Migraciones=n) 
) %>% mutate(
  p_migraciones=percent(as.numeric(Migraciones) / as.numeric(`No consintieron`),1)
) %>% left_join(
  dt_rechazos_motivos %>% filter(!is.na(no_autoriza_padre_familiar)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, 
                                           no_autoriza_padre_familiar=n) 
) %>% mutate(
  p_no_autoriza_padre=percent(as.numeric(no_autoriza_padre_familiar) / as.numeric(`No consintieron`),1)
) %>% left_join(
  dt_rechazos_motivos %>% filter(!is.na(falta_valor_al_estudio)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, 
                                           falta_valor_al_estudio=n) 
) %>% mutate(
  p_falta_valor_al_estudio=percent(as.numeric(falta_valor_al_estudio) / as.numeric(`No consintieron`),1)
)%>% left_join(
  dt_rechazos_motivos %>% filter(!is.na(no_tiene_tiempo)) %>%  mutate( Mes=format(s4_date, "%B")) %>% group_by(
  Anio=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  Mes
) %>%  count() %>% ungroup() %>% transmute(Anio, Mes, 
                                           no_tiene_tiempo=n) 
) %>% mutate(
  p_no_tiene_tiempo=percent(as.numeric(no_tiene_tiempo) / as.numeric(`No consintieron`),1)
) %>% transmute(
  `A√±o`=Anio,
  Mes,
  Consentidos,
  `No consintieron(%)`=if_else(is.na(`No consintieron`), NA_character_, paste0(`No consintieron`,"(",p_no_consintieron,")")),
   Migraciones=if_else(is.na(Migraciones), NA_character_, paste0(Migraciones,"(",p_migraciones,")")),
  `No autoriza padre o familiar(%)`=if_else(is.na(no_autoriza_padre_familiar), NA_character_, paste0(no_autoriza_padre_familiar,"(",p_no_autoriza_padre,")")),
   `Falta valor al estudio(%)`=if_else(is.na(falta_valor_al_estudio), NA_character_, paste0(falta_valor_al_estudio,"(",p_falta_valor_al_estudio,")")),
  `No tiene tiempo`=if_else(is.na(no_tiene_tiempo), NA_character_, paste0(no_tiene_tiempo,"(",p_no_tiene_tiempo,")"))
) %>% kable(caption = "<center>REPORTE MENSUAL <br>
                  DE RECHAZOS</center>", 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria") 

```
~~~~
 *Quincena del  "`r as.Date(f_week1) %>% format(.,"%A %d %B  %Y")`" al "`r as.Date(f_week2) %>% format(.,"%A %d %B  %Y")` "*
~~~~

## REPORTES FOT
#### CONTEOS: "C86 FOT & BASE DE DATOS TREMOFLO"
```{r}
#primer dia realizados en fase 1
fase_1<-gt_hapin_II_data %>%  select(id_hapin=id, c86_date, c86_complete_test1, c86_complete_test1_2) %>% 
  filter(!is.na(c86_date)) %>% #quitar a los ids aun no abordados 
  mutate(month = format(c86_date, "%m"), year = format(c86_date, "%Y")) %>%
  arrange(year, month, c86_date) %>% 
  group_by(year, month) %>% 
  filter(c86_date <= "2022-05-16") %>% 
  select(year, month, c86_complete_test1, c86_complete_test1_2) %>% 
  count() %>% 
  rename("C86_realizados"=n)

#segundo dia realizados en fase 1
f1_2d <- gt_hapin_II_data %>% 
  select(id_hapin=id, c86_date, c86_complete_test1, c86_complete_test1_2) %>% 
  filter(!is.na(c86_date)) %>% #quitar a los ids aun no abordados 
  mutate(month = format(c86_date, "%m"), year = format(c86_date, "%Y")) %>%
  arrange(year, month, c86_date) %>% 
  group_by(year, month) %>% 
  filter(c86_date <= "2022-05-16") %>% 
  filter(c86_complete_test1 =="1", c86_complete_test1_2 == "1") %>% 
  select(year, month, c86_complete_test1, c86_complete_test1_2) %>% 
  count() %>% 
  rename("Completado_dos_dias"=n)

f1_np <- gt_hapin_II_data %>% 
  select(id_hapin=id, c86_date, c86_complete_test1, c86_complete_test1_2) %>% 
  filter(!is.na(c86_date)) %>% #quitar a los ids aun no abordados 
  mutate(month = format(c86_date, "%m"), year = format(c86_date, "%Y")) %>%
  arrange(year, month, c86_date) %>% 
  group_by(year, month) %>% 
  filter(c86_date <= "2022-05-16") %>% 
  filter(c86_complete_test1 =="0", c86_complete_test1_2 == "0") %>% 
  select(year, month, c86_complete_test1, c86_complete_test1_2) %>% 
  count() %>% 
  rename("No_participo"=n)
#integrar fase 1
fase_1 <- fase_1 %>% 
  left_join(f1_2d, by=c("year", "month")) %>% 
  left_join(f1_np, by=c("year", "month")) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate("Completado_un_dia" = reduce(across(all_of(c("C86_realizados", "Completado_dos_dias", "No_participo"))), `-`)) %>% 
  relocate("Completado_un_dia", .after=4)
#liberar espacio df que ya no se utilizaran
remove(f1_2d, f1_np)

#integrar fases
fase_total <- gt_hapin_II_data %>% 
  select(id_hapin=id, c86_date, c86_complete_test1, c86_complete_test1_2) %>% 
  filter(!is.na(c86_date)) %>% #quitar a los ids aun no abordados 
  mutate(month = format(c86_date, "%m"), year = format(c86_date, "%Y")) %>%
  arrange(year, month, c86_date) %>% 
  group_by(year, month) %>% 
  select(year, month, c86_complete_test1, c86_complete_test1_2) %>% 
  count() %>% 
  rename("C86_realizados"=n)

ft_2d <- gt_hapin_II_data %>% 
  select(id_hapin=id, c86_date, c86_complete_test1, c86_complete_test1_2) %>% 
  filter(!is.na(c86_date)) %>% #quitar a los ids aun no abordados 
  mutate(month = format(c86_date, "%m"), year = format(c86_date, "%Y")) %>%
  arrange(year, month, c86_date) %>% 
  group_by(year, month) %>% 
  filter(c86_complete_test1 =="1", c86_complete_test1_2 == "1") %>% 
  select(year, month, c86_complete_test1, c86_complete_test1_2) %>% 
  count() %>% 
  rename("Completado_dos_dias"=n)

#fase total no participo
ft_np <- gt_hapin_II_data %>% 
  select(id_hapin=id, c86_date, c86_complete_test1, c86_complete_test1_2) %>% 
  filter(!is.na(c86_date)) %>% #quitar a los ids aun no abordados 
  mutate(month = format(c86_date, "%m"), year = format(c86_date, "%Y")) %>%
  arrange(year, month, c86_date) %>% 
  group_by(year, month) %>% 
  filter(c86_complete_test1 =="0", c86_complete_test1_2 == "0") %>% 
  select(year, month, c86_complete_test1, c86_complete_test1_2) %>% 
  count() %>% 
  rename("No_participo"=n)

#integrar fase total
fase_total <- fase_total %>% 
  left_join(ft_2d, by=c("year", "month")) %>% 
  left_join(ft_np, by=c("year", "month")) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate("Completado_un_dia" = reduce(across(all_of(c("C86_realizados", "Completado_dos_dias", "No_participo"))), `-`)) %>% 
  relocate("Completado_un_dia", .after=4)
#quitar df que ya no se usar√°n
remove(ft_2d, ft_np)

#convertir el nombre de los meses
fase_total <- transform(fase_total, month = ifelse(month == "01", "Enero", month))
fase_total <- transform(fase_total, month = ifelse(month == "02", "Febrero", month))
fase_total <- transform(fase_total, month = ifelse(month == "03", "Marzo", month))
fase_total <- transform(fase_total, month = ifelse(month == "04", "Abril", month))
fase_total <- transform(fase_total, month = ifelse(month == "05", "Mayo", month))
fase_total <- transform(fase_total, month = ifelse(month == "06", "Junio", month))
fase_total <- transform(fase_total, month = ifelse(month == "07", "Julio", month))
fase_total <- transform(fase_total, month = ifelse(month == "08", "Agosto", month))
fase_total <- transform(fase_total, month = ifelse(month == "09", "Septiembre", month))
fase_total <- transform(fase_total, month = ifelse(month == "10", "Octubre", month))
fase_total <- transform(fase_total, month = ifelse(month == "11", "Noviembre", month))
fase_total <- transform(fase_total, month = ifelse(month == "12", "Diciembre", month))


fase_1 <- transform(fase_1, month = ifelse(month == "01", "Enero", month))
fase_1 <- transform(fase_1, month = ifelse(month == "02", "Febrero", month))
fase_1 <- transform(fase_1, month = ifelse(month == "03", "Marzo", month))
fase_1 <- transform(fase_1, month = ifelse(month == "04", "Abril", month))
fase_1 <- transform(fase_1, month = ifelse(month == "05", "Mayo", month))
fase_1 <- transform(fase_1, month = ifelse(month == "06", "Junio", month))
fase_1 <- transform(fase_1, month = ifelse(month == "07", "Julio", month))

#frecuencias y porcentajes acumulados -----
fase_total <- fase_total %>% 
  mutate(C86_realizados_acumulados = cumsum(C86_realizados),
         porcentaje_acumulado = cumsum(rep(1/n(), n())*100)) %>% 
  mutate(porcentaje_acumulado = str_c(round(porcentaje_acumulado), "%")) %>% 
  select(year, month, C86_realizados, C86_realizados_acumulados, porcentaje_acumulado, Completado_dos_dias, Completado_un_dia, No_participo)


fase_1 <- fase_1 %>% 
  mutate(C86_realizados_acumulados = cumsum(C86_realizados),
         porcentaje_acumulado = cumsum(rep(1/n(), n())*100)) %>% 
  mutate(porcentaje_acumulado = str_c(round(porcentaje_acumulado), "%")) %>% 
  select(year, month, C86_realizados, C86_realizados_acumulados, porcentaje_acumulado, Completado_dos_dias, Completado_un_dia, No_participo)


#agregar programados por mes (todos los consentidos por mes) ----
t_consentidos<-gt_hapin_II_data %>% filter(!is.na(s4_date)) %>% filter(visit=="b6") %>% select(
  id, s4_date, s4_consent_c
) %>% filter(s4_consent_c=="1") %>% group_by(
  year=lubridate::year(s4_date),
  mes=lubridate::month(s4_date),
  month=format(as.Date(s4_date), "%B")
) %>% count() %>% ungroup() %>% select(year, month, consentidos=n)
#agregar acumulado por mes de consentidos ---
t_consentidos<-t_consentidos %>% mutate(
  acumulado=cumsum(as.numeric(consentidos))
)

#integrar consentidos a la fase 1 ----
fase_1<-fase_1 %>% mutate(month=tolower(month)) %>% left_join(
  t_consentidos %>% transmute(year=as.character(year), month, consentidos,
                            acumulado_consentidos=acumulado)
)


#tabla reporte fase 1
fase1_report <- fase_1 %>% select(1:2,9:10,3:8) %>% 
  gt() %>% 
  tab_header (title= md("FASE 1 AVANCE MENSUAL FOT")) %>% 
  cols_label(year = html("A&ntildeo"), 
             month = "Mes",
             consentidos="Consentidos",
             acumulado_consentidos="Consentidos Acumulado",
             C86_realizados_acumulados = "C86 acumulados",
             porcentaje_acumulado = "%",
             C86_realizados = "C86 realizados",
             Completado_dos_dias = "Completado dos dias",
             Completado_un_dia = "Completado un dia",
             No_participo = "No participo"
             ) %>% 
  opt_align_table_header(align = "left") %>% 
  cols_width(C86_realizados ~ px(75),
             C86_realizados_acumulados ~ px(50),
             porcentaje_acumulado ~ px(25),
             Completado_dos_dias ~ px(50),
             Completado_un_dia ~ px(50),
             No_participo ~ px(50)) %>% 
  tab_footnote(footnote= "Fase 1: 24 de febrero hasta el 16 de mayo 2022",
               locations= list(
                 cells_column_labels(columns=month))) %>% 
    data_color(
    columns = C86_realizados,
    colors = scales::col_numeric(
      palette = c("gray"),
      domain = c(NULL)))

#integrar consentidos a la fase total
fase_total<-fase_total %>% mutate(month=tolower(month)) %>% left_join(
  t_consentidos %>% transmute(year=as.character(year), month, consentidos,
                            acumulado_consentidos=acumulado)
)

fasetotal_report <- fase_total %>% select(1:2,9:10,3:8) %>% 
  gt() %>% 
  tab_header (title= md("Reporte de Avance Mensual FOT 2022")) %>% 
  cols_label(year = html("A&ntildeo"), 
             month = "Mes",
             consentidos="Consentidos",
             acumulado_consentidos="Consentidos Acumulado",
             C86_realizados = "C86 realizados",
             C86_realizados_acumulados = "C86 acumulados",
             porcentaje_acumulado = "%",
             Completado_dos_dias = "Completado dos dias",
             Completado_un_dia = "Completado un dia",
             No_participo = "No participo"
             ) %>% 
  opt_align_table_header(align = "left") %>% 
  cols_width(C86_realizados ~ px(75),
             C86_realizados_acumulados ~ px(50),
             porcentaje_acumulado ~ px(25),
             Completado_dos_dias ~ px(50),
             Completado_un_dia ~ px(50),
             No_participo ~ px(50)) %>%  
  tab_footnote(footnote= "Fase 1: 24 de febrero hasta el 16 de mayo 2022",
               locations= list(
                 cells_column_labels(columns=month))) %>% 
    data_color(
    columns = C86_realizados,
    colors = scales::col_numeric(
      palette = c("gray"),
      domain = c(NULL)))

#graficar tablas
fase1_report
fasetotal_report
```



#### Resumen pruebas realizadas
##### Inicio de actividad: el 24 de marzo del 2022 haciendo fot en  dia 1 y dia 2
##### Modificaci√≥n 1: El 17 de mayo del 2022 se inci√≥ a hacer FOT √∫nicamente el dia 2 de exposici√≥n
~~~~
**Nota:** del 6 al 14 de septiembre, 2 equipos de exposici√≥n: 1 har√° fot y el otro no
~~~~

```{r FOT, echo=FALSE}
dt_fot<-gt_hapin_II_data %>% filter(redcap_event_name=="year_3_q1_36m_arm_1") %>% filter(!is.na(c86_date)) %>%  select(
  id, c86_date, dos_pruebas_dia1= c86_complete_test1, dos_pruebas_dia2=c86_complete_test1_2
)

# FOT B6 FASE 1 DEL 24 DE MARZO AL 16 DE MAYO 2022
Actividad<-c("C86 realizados","Dos pruebas completas dia 1", "Dos pruebas completas dia 2")
reporte_fot<-data.frame(Actividad)

reporte_fot %>% mutate(
  Acumulado=case_when(
     Actividad=="C86 realizados" ~ dt_fot %>% filter(as.Date(c86_date)<="2022-05-16" ) %>% count() %>% .$n,
      Actividad=="Dos pruebas completas dia 1" ~  dt_fot %>% filter(as.Date(c86_date)<="2022-05-16" ) %>% filter(
      dos_pruebas_dia1=="1"
    ) %>%  count() %>% .$n,
    Actividad=="Dos pruebas completas dia 2" ~  dt_fot %>% filter(as.Date(c86_date)<="2022-05-16" )%>% filter(
      dos_pruebas_dia2=="1"
    ) %>%  count() %>% .$n,
    TRUE ~ NA_integer_
  )
)   %>% kable(caption = "<center>REPORTE C86 (FOT EN DIA 1 Y DIA 2)<br>
                  FASE 1 (24-03-2022 al 16-05-2022) </center>", 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria") %>% column_spec(2, width = "2cm",  bold = T, color="blue")


```

```{r FOT_f2, echo=FALSE}
#FASE 2 (FOT EN DIA 2 DE EXPOSICION)
Actividad<-c("C86 realizados","Dos pruebas completas")
reporte_fot<-data.frame(Actividad)

reporte_fot %>% mutate(
   Quincenal=case_when(
     Actividad=="C86 realizados" ~  dt_fot %>% filter(as.Date(c86_date)>="2022-05-17" ) %>% filter(c86_date>=fecha1 & c86_date<=fecha2) %>% count() %>% .$n,
     Actividad=="Dos pruebas completas" ~ dt_fot %>% filter(c86_date>=fecha1 & c86_date<=fecha2) %>% filter(
      dos_pruebas_dia1=="1"
    ) %>%  count() %>% .$n,
   ),
  Acumulado=case_when(
     Actividad=="C86 realizados" ~ dt_fot %>% filter(as.Date(c86_date)>="2022-05-17" ) %>% count() %>% .$n,
      Actividad=="Dos pruebas completas" ~  dt_fot %>% filter(as.Date(c86_date)>="2022-05-17" ) %>% filter(
      dos_pruebas_dia1=="1"
    ) %>%  count() %>% .$n,
    TRUE ~ NA_integer_
  )
)   %>% kable(caption =paste0( "<center>REPORTE C86 (FOT EN DIA 2 DE EXPOSICION)<br>
                  FASE 2 (17-05-2022 al ", fecha2," </center>"), 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria") %>% column_spec(2, width = "2cm",  bold = T, color="blue") 

```


~~~~
 *Quincena del  "`r as.Date(f_week1) %>% format(.,"%A %d %B  %Y")`" al "`r as.Date(f_week2) %>% format(.,"%A %d %B  %Y")` "*
~~~~


## PRODUCTIVIDAD
#### REPORTE DE PRODUCTIVIDAD HAPIN 36 MESES

```{r productividad, echo=FALSE}

#para equipo de reclutamiento tomar M10
rec_semana<-gt_hapin_II_data %>% filter(!is.na(m10_date)) %>% filter(visit=="b6") %>% select(
  m10_date, m10_by
) %>% mutate(
  semana=lubridate::week(m10_date),
  mes=lubridate::month(m10_date),
  Mes=format(m10_date, "%B")
) %>% arrange(semana) %>% group_by(semana) %>% count() %>% mutate(media=round(n/5)) %>% select(-n) %>% 
  mutate(equipo="Reclutamiento")

rec_mes<-gt_hapin_II_data %>% filter(!is.na(m10_date)) %>% filter(visit=="b6") %>% select(
  m10_date, m10_by
) %>% mutate(
  semana=lubridate::week(m10_date),
  mes=lubridate::month(m10_date),
  Mes=format(m10_date, "%B")
) %>% arrange(semana) %>% group_by(mes,Mes) %>% count() %>% mutate(media=round(n/20)) %>% select(-n) %>% 
  mutate(equipo="Reclutamiento")

#para equipo de reclutamiento tomar H41
exp_semana<-gt_hapin_II_data %>% filter(!is.na(h41_date_v2)) %>% filter(visit=="b6") %>% select(
  h41_date_v2, h41_by_v2
) %>% mutate(
  semana=lubridate::week(h41_date_v2),
  mes=lubridate::month(h41_date_v2),
  Mes=format(h41_date_v2, "%B")
) %>% arrange(semana) %>% group_by(semana) %>% count() %>% mutate(media=round(n/4)) %>% select(-n) %>% 
  mutate(equipo="Exposicion")

exp_mes<-gt_hapin_II_data %>% filter(!is.na(h41_date_v2)) %>% filter(visit=="b6") %>% select(
  h41_date_v2, h41_by_v2
) %>% mutate(
  semana=lubridate::week(h41_date_v2),
  mes=lubridate::month(h41_date_v2),
  Mes=format(h41_date_v2, "%B")
) %>% arrange(mes,Mes) %>% group_by(mes,Mes) %>% count() %>% mutate(media=round(n/16)) %>% select(-n) %>% 
  mutate(equipo="Exposicion")

#integramos medias de equipos
g_equipo_semana<- rec_semana %>% bind_rows(
  exp_semana
) %>% ggplot(
 aes(x=semana, y=media, color=equipo)
)+ geom_line(stat="identity", size=1)+ 
  #geom_bar(stat = "identity", position = "dodge") + 
  theme(axis.text.x = element_text( size = 8))+
   scale_x_continuous(name="Semana", breaks = c(8:52)) + scale_y_continuous(name="Media", breaks = c(0:12))+
  labs(
    title = "MEDIA DE PRODUCTIVIDAD POR SEMANA",
    subtitle = "Hapin 36 meses",
    caption = "Indicador trazador Reclutamiento: M10 con Media sobre 5 dias habiles, Exposicion: H41 con Media sobre 4 dias habiles"
  )  + theme(plot.title = element_text(hjust=0.5),
            plot.subtitle = element_text(hjust = 0.5),
            plot.caption = element_text(hjust=0.5, size = 7)
            ) 




g_equipo_mes<- rec_mes %>% bind_rows(
  exp_mes 
) %>%  ggplot(
 aes(x=mes, y=media, color=equipo)
)+ geom_line(stat="identity", size=1)+ 
  #geom_bar(stat = "identity", position = "dodge") + 
  theme(axis.text.x = element_text( size = 8))+
   scale_x_continuous(name="Mes", breaks = c(1:12)) + scale_y_continuous(name="Media", 
                                                                         breaks = c(0:12))+
  labs(
    title = "MEDIA DE PRODUCTIVIDAD POR MES",
    subtitle = "Hapin 36 meses",
    caption = "Indicador trazador Reclutamiento: M10 con Media sobre 20 dias habiles, Exposicion: H41 con Media sobre 16 dias habiles"
  )  + theme(plot.title = element_text(hjust=0.5),
            plot.subtitle = element_text(hjust = 0.5),
            plot.caption = element_text(hjust=0.5, size = 6)
            ) 

#data grafica por iniciales reclutamiento
# rec_iniciales<-gt_hapin_II_data %>% filter(!is.na(m10_date)) %>% filter(visit=="b6") %>% select(
#   m10_date, iniciales=m10_by
# ) %>% mutate(
#   semana=lubridate::week(m10_date),
#   mes=lubridate::month(m10_date),
#   Mes=format(m10_date, "%B")
# ) %>% arrange(semana) %>% group_by(semana, iniciales) %>% count() %>% mutate(media=round(n/5)) %>% select(-n) %>% 
#   mutate(equipo="Reclutamiento")
# 
# rec_iniciales %>% group_by(iniciales) %>% count()
# gt_hapin_II_data %>% filter(m10_by=="1") %>% select(id, m10_by)
# 
# m10<-gt_hapin_II_data %>% filter(!is.na(m10_date)) %>% filter(visit=="b6") %>% select(
#   fecha=m10_date, iniciales=m10_by
# ) %>% mutate(
#   crf="m10",
#   semana=lubridate::week(fecha),
#   mes=lubridate::month(fecha),
#   Mes=format(fecha, "%B")
# ) %>% arrange(semana)
# 
# c31<-gt_hapin_II_data %>% filter(!is.na(c31_date_2)) %>% filter(visit=="b6") %>% select(
#   fecha=c31_date_2, iniciales=c31_by_2
# ) %>% mutate(
#   crf="c31",
#   semana=lubridate::week(fecha),
#   mes=lubridate::month(fecha),
#   Mes=format(fecha, "%B")
# ) %>% arrange(semana)
# 
# m10 %>% bind_rows(
#   c31
# ) %>% group_by(iniciales, crf, semana) %>% count()

#grafica por semana
g_equipo_semana

#tabla por semana

rec_semana %>% bind_rows(
  exp_semana
) %>% mutate(
  media_reclutamiento=if_else(equipo=="Reclutamiento",media, NA_real_),
  media_exposicion=if_else(equipo=="Exposicion",media, NA_real_),
) %>% filter(!is.na(media_reclutamiento)) %>% select(semana, media_reclutamiento) %>% 
  left_join(
    rec_semana %>% bind_rows(
  exp_semana
) %>% mutate(
  media_reclutamiento=if_else(equipo=="Reclutamiento",media, NA_real_),
  media_exposicion=if_else(equipo=="Exposicion",media, NA_real_),
) %>% filter(!is.na(media_exposicion)) %>% select(semana, media_exposicion)
    
  ) %>% kable(caption = paste0( "<center>REPORTE PRODUCTIVIDAD POR SEMANA<br>
                  HAPIN 36 meses al ", fecha2," </center>"), 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria") %>% column_spec(1, width = "2cm",  bold = T) %>%  kable_styling("striped", full_width = F) %>% scroll_box(width = "500px", height = "300px")

#grafica por mes
g_equipo_mes

#tabla mes
rec_mes %>% bind_rows(
  exp_mes
) %>% mutate(
  media_reclutamiento=if_else(equipo=="Reclutamiento",media, NA_real_),
  media_exposicion=if_else(equipo=="Exposicion",media, NA_real_),
) %>% filter(!is.na(media_reclutamiento)) %>% select(mes, Mes, media_reclutamiento) %>% 
  left_join(
    rec_mes %>% bind_rows(
  exp_mes
) %>% mutate(
  media_reclutamiento=if_else(equipo=="Reclutamiento",media, NA_real_),
  media_exposicion=if_else(equipo=="Exposicion",media, NA_real_),
) %>% filter(!is.na(media_exposicion)) %>% select(mes,Mes, media_exposicion)
    
  ) %>% ungroup() %>% arrange(mes) %>% select(-mes) %>%  kable(caption = paste0( "<center>REPORTE PRODUCTIVIDAD POR MES<br>
                  HAPIN 36 meses al ", fecha2," </center>"), 
        align = "l") %>% 
    kable_classic(full_width=F, html_font = "Cambria") %>% column_spec(1, width = "2cm",  bold = T) %>%  kable_styling("striped", full_width = F) %>% scroll_box(width = "500px", height = "300px")

```

```{r promedios_crfs}

rec_por_dia_mes<-gt_hapin_II_data %>% filter(!is.na(c32_date_2)) %>% filter(visit=="b6") %>% 
  transmute(
    c32_date_2
  ) %>% mutate(
    Anio=lubridate::year(c32_date_2),
    mes=lubridate::month(c32_date_2),
    Mes=str_to_title(format(as.Date(c32_date_2), "%B")),
    semana=lubridate::week(c32_date_2),
    dia=lubridate::wday(c32_date_2, label = TRUE, abbr = FALSE)
  ) %>% group_by(Anio, mes, Mes, semana, dia) %>% count() %>% ungroup() %>% transmute(
    Anio, mes, Mes, semana, dia, realizados=n
  )


exp_por_dia_mes<-gt_hapin_II_data %>% filter(!is.na(h42_date_2)) %>% filter(visit=="b6") %>% 
  transmute(
    h42_date_2
  ) %>% mutate(
    Anio=lubridate::year(h42_date_2),
    mes=lubridate::month(h42_date_2),
    Mes=str_to_title(format(as.Date(h42_date_2), "%B")),
    semana=lubridate::week(h42_date_2),
    dia=lubridate::wday(h42_date_2, label = TRUE, abbr = FALSE)
  ) %>% group_by(Anio, mes, Mes, semana, dia) %>% count() %>% ungroup() %>% transmute(
    Anio, mes, Mes, semana, dia, realizados=n
  )

#productividad FOT
fot_por_dia_mes<-gt_hapin_II_data %>% filter(!is.na(c86_date)) %>% filter(visit=="b6") %>% 
  transmute(
    c86_date
  ) %>% mutate(
    Anio=lubridate::year(c86_date),
    mes=lubridate::month(c86_date),
    Mes=str_to_title(format(as.Date(c86_date), "%B")),
    semana=lubridate::week(c86_date),
    dia=lubridate::wday(c86_date, label = TRUE, abbr = FALSE)
  ) %>% group_by(Anio, mes, Mes, semana, dia) %>% count() %>% ungroup() %>% transmute(
    Anio, mes, Mes, semana, dia, realizados=n
  )

#preparar set de datos para grafica reclutamiento dia mes
dt_rec_promedio_dia_mes<-rec_por_dia_mes %>% group_by(
  Anio, mes, Mes, dia
) %>% summarise(realizados_dia=sum(realizados)) %>% ungroup() %>% 
  left_join(
rec_por_dia_mes %>% group_by(Anio,mes, dia) %>% count() %>% ungroup() %>% transmute(Anio, mes, dia, contador_dia=n)
) %>% mutate(
  promedio_dia_mes= realizados_dia / contador_dia
) %>%  left_join(
  rec_por_dia_mes %>% group_by(Anio,mes) %>% summarise(total_mes=sum(realizados)) %>% ungroup() 
) %>% mutate(
  prop_dia=percent(promedio_dia_mes/total_mes, digits = 1)
) %>% transmute(
  Anio, mes, Mes, dia, promedio_por_dia=round(promedio_dia_mes,digits = 0), prop_dia, total_mes
) %>% distinct()

#preparar set de datos para grafica Exposicion dia mes
dt_exp_promedio_dia_mes<-exp_por_dia_mes %>% group_by(
  Anio, mes, Mes, dia
) %>% summarise(realizados_dia=sum(realizados)) %>% ungroup() %>% 
  left_join(
exp_por_dia_mes %>% group_by(Anio,mes, dia) %>% count() %>% ungroup() %>% transmute(Anio, mes, dia, contador_dia=n)
) %>% mutate(
  promedio_dia_mes= realizados_dia / contador_dia
) %>%  left_join(
  exp_por_dia_mes %>% group_by(Anio,mes) %>% summarise(total_mes=sum(realizados)) %>% ungroup() 
) %>% mutate(
  prop_dia=percent(promedio_dia_mes/total_mes, digits = 1)
) %>% transmute(
  Anio, mes, Mes, dia, promedio_por_dia=round(promedio_dia_mes,digits = 0), prop_dia, total_mes
) %>% distinct()

#preparar set de datos para grafica FOT dia mes
dt_fot_promedio_dia_mes<-fot_por_dia_mes %>% group_by(
  Anio, mes, Mes, dia
) %>% summarise(realizados_dia=sum(realizados)) %>% ungroup() %>% 
  left_join(
fot_por_dia_mes %>% group_by(Anio,mes, dia) %>% count() %>% ungroup() %>% transmute(Anio, mes, dia, contador_dia=n)
) %>% mutate(
  promedio_dia_mes= realizados_dia / contador_dia
) %>%  left_join(
  fot_por_dia_mes %>% group_by(Anio,mes) %>% summarise(total_mes=sum(realizados)) %>% ungroup() 
) %>% mutate(
  prop_dia=percent(promedio_dia_mes/total_mes, digits = 1)
) %>% transmute(
  Anio, mes, Mes, dia, promedio_por_dia=round(promedio_dia_mes,digits = 0), prop_dia, total_mes
) %>% distinct()

# nb.cols<-30
# display.brewer.all()
# mycolors<- colorRampPalette(brewer.pal(10,"Dark2"))(nb.cols)

#productividad por dia, agrupado por mes barras
g_produc_reclutamiento_dia_mes<- dt_rec_promedio_dia_mes %>% ggplot(
  aes(x=mes, y=promedio_por_dia, group=dia, fill=dia, width=0.90)
) + geom_bar(
                  stat = "identity", position = "dodge", color="black"
                ) + scale_fill_manual(values = c(
                  '#aeb6bf', '#a9dfbf',  '#819FF7', '#f1948a', '#bb8fce', '#cd6155'
                )
                                      ) +
  #scale_fill_brewer(palette = "RdGy") +
  #scale_fill_manual(values = mycolors) +
  
  theme(axis.text.x = element_text( size = 8))+
   scale_x_continuous(name="Mes", breaks = c(1:12)) + scale_y_continuous(name="Promedio", 
                                                                         breaks = c(0:12))+
  labs(
    title = "PROMEDIO DE PRODUCTIVIDAD DIA / MES",
    subtitle = "Reclutamiento Hapin 36 meses",
    caption = "Indicador trazador Reclutamiento: M10"
  )  + theme(plot.title = element_text(hjust=0.5),
            plot.subtitle = element_text(hjust = 0.5),
            plot.caption = element_text(hjust=0.5, size = 6)
            ) 





#productividad por dia, agrupado por mes barras
g_produc_expo_dia_mes<-dt_exp_promedio_dia_mes %>% ggplot(
  aes(x=mes, y=promedio_por_dia, group=dia, fill=dia, width=0.90)
) + geom_bar(
                  stat = "identity", position = "dodge", color="black"
                ) + scale_fill_manual(values = c(
                  '#aeb6bf', '#a9dfbf',  '#819FF7', '#f1948a', '#bb8fce', '#cd6155'
                )
                                      ) +
  theme_get()+
  theme(axis.text.x = element_text( size = 8))+
   scale_x_continuous(name="Mes", breaks = c(1:12)) + scale_y_continuous(name="Promedio", 
                                                                         breaks = c(0:12))+
  labs(
    title = "PROMEDIO DE PRODUCTIVIDAD DIA / MES",
    subtitle = "Exposicion Hapin 36 meses",
    caption = "Indicador trazador Exposicion: H42"
  )  + theme(plot.title = element_text(hjust=0.5),
            plot.subtitle = element_text(hjust = 0.5),
            plot.caption = element_text(hjust=0.5, size = 6)
            ) 

#productividad  FOT por dia, agrupado por mes barras
g_produc_fot_dia_mes<-dt_fot_promedio_dia_mes %>% ggplot(
  aes(x=mes, y=promedio_por_dia, group=dia, fill=dia, width=0.90)
) + geom_bar(
                  stat = "identity", position = "dodge", color="black"
                ) + scale_fill_manual(values = c(
                  '#aeb6bf', '#a9dfbf',  '#819FF7', '#f1948a', '#bb8fce', '#cd6155'
                )
                                      ) +
  theme_get()+
  theme(axis.text.x = element_text( size = 8))+
   scale_x_continuous(name="Mes", breaks = c(1:12)) + scale_y_continuous(name="Promedio", 
                                                                         breaks = c(0:12))+
  labs(
    title = "PROMEDIO DE PRODUCTIVIDAD DIA / MES",
    subtitle = "FOT Hapin 36 meses",
    caption = "Indicador trazador Exposicion: C86"
  )  + theme(plot.title = element_text(hjust=0.5),
            plot.subtitle = element_text(hjust = 0.5),
            plot.caption = element_text(hjust=0.5, size = 6)
            ) 

g_produc_reclutamiento_dia_mes


g_produc_expo_dia_mes

g_produc_fot_dia_mes

```

~~~~
 *Productividad al "`r as.Date(f_week2) %>% format(.,"%A %d %B  %Y")` "*
~~~~


## MDAT {.tabset}
#### REPORTE DE MDAT HAPIN 36 MESES
```{r mdat}
#datos de c85 export de redcap
mdat<-gt_hapin_II_data %>%  filter(!c85_date %in% c("")) %>% filter(!is.na(c85_date)) %>% 
  select(id, c85_date, c85_complete, c85_section___1, c85_section___2, c85_section___3, c85_section___4) %>% 
  mutate(weekday = weekdays(as.Date(c85_date))) 

#agregar 
mdat$week <- strftime(mdat$c85_date, format = "%V")
mdat$month <- strftime(mdat$c85_date, format = "%m")
mdat$year <- strftime(mdat$c85_date, format = "%Y")

mdat <- mdat %>% 
  group_by(month) %>% 
  mutate(c85_complete = factor(c85_complete, levels = c(1,0), labels=c("Completo", "No Completo")),
         c85_section___1 = factor(c85_section___1, levels = c(1,0), labels=c("No completo", "Completo")),
         c85_section___2 = factor(c85_section___2, levels = c(1,0), labels=c("No completo", "Completo")),
         c85_section___3 = factor(c85_section___3, levels = c(1,0), labels=c("No completo", "Completo")),
         c85_section___4 = factor(c85_section___4, levels = c(1,0), labels=c("No completo", "Completo"))) %>% 
  mutate(month=as.integer(month)) %>% 
         mutate(
           Mes= factor(month, levels = c(01, 02, 03, 04, 05, 06, 07, 08, 09, 10, 11, 12), labels=c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"))
                ) %>% 
  select(id, year, month, Mes, week, weekday, everything())
#agregar realizados
mdat <- mdat %>% 
  mutate(Realizados=as.numeric("1"))

#total mdat abordados
total <- mdat %>% 
  group_by(year, month, Mes) %>% 
  arrange(month) %>% 
  count() %>% 
  ungroup() %>% 
  select(year, Mes, n) %>% 
  rename(Total=n)


#completos y no completos

total <- mdat %>% 
  select(year, month, Mes, c85_complete) %>% 
  group_by(year, Mes, c85_complete) %>% 
  count() %>% 
  left_join(total, by = c("year", "Mes")) %>% 
  pivot_wider(
    names_from = c85_complete,
    values_from = n) %>% 
  select("A√±o"=year, Mes, Completo, "No Completo", Total) 

totales <- total %>% 
  ungroup() %>% 
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE)))

total %>% 
bind_rows(totales) %>%
  mutate(Mes = if_else(is.na(Mes), "Total", as.character(Mes))) %>% 
  mutate(A√±o = if_else(is.na(A√±o), " ", as.character(A√±o))) %>% 
  kable(caption="<center>Avance Mensual <br>
        Evaluaciones MDAT</center>", align="l") %>% 
  kable_classic(full_width=F, html_font="Cambria")


#incompletos
#mdat no completos
nc_mdat <- mdat %>% 
  group_by(year,month, Mes) %>% 
  select(year, month, Mes, c85_complete) %>% 
  filter(c85_complete %in% c("No Completo")) %>% 
  arrange(year,month) %>% 
  mutate(n=1) %>% 
  select(year,month, Mes, n) %>% 
  count() %>% 
  ungroup() %>% 
  select(year,Mes, n) %>% 
  rename(MDAT_no_completos=n)

#Motor grueso incompletos
nc_mg <- mdat %>% 
  group_by(year,month, Mes) %>% 
  select(year,month, Mes, c85_section___1) %>% 
  rename(motor_grueso=c85_section___1) %>% 
  filter(motor_grueso %in% c("No completo")) %>% 
  arrange(year,month) %>% 
  mutate(n=1) %>% 
  select(year,month, Mes, n) %>% 
  count() %>% 
  ungroup() %>% 
  select(year, Mes, n) %>% 
  rename(incompleto_motor_grueso=n)

#motor fino incompletos
nc_mf <- mdat %>% 
  group_by(year, month, Mes) %>% 
  select(year, month, Mes, c85_section___2) %>% 
  rename(motor_fino=c85_section___2) %>% 
  filter(motor_fino %in% c("No completo")) %>% 
  arrange(year,month) %>% 
  mutate(n=1) %>% 
  select(year,month, Mes, n) %>% 
  count() %>% 
  ungroup() %>% 
  select(year,Mes, n) %>% 
  rename(incompleto_motor_fino=n)

#lenguaje incompletos
nc_l <- mdat %>% 
  group_by(year,month, Mes) %>% 
  select(year,month, Mes, c85_section___3) %>% 
  rename(lenguaje=c85_section___3) %>% 
  filter(lenguaje %in% c("No completo")) %>% 
  arrange(year,month) %>% 
  mutate(n=1) %>% 
  select(year, month, Mes, n) %>% 
  count() %>% 
  ungroup() %>% 
  select(year, Mes, n) %>% 
  rename(incompleto_lenguaje=n)

#social incompletos
nc_s <- mdat %>% 
  group_by(year,month, Mes) %>% 
  select(year, month, Mes, c85_section___4) %>% 
  rename(social=c85_section___4) %>% 
  filter(social %in% c("No completo")) %>% 
  arrange(year, month) %>% 
  mutate(n=1) %>% 
  select(year, month, Mes, n) %>% 
  count() %>% 
  ungroup() %>% 
  select(year, Mes, n) %>% 
  rename(incompleto_social=n)

#integrar los no completos
nc_mdat <- nc_mdat %>% 
  left_join(nc_mg) %>% 
  left_join(nc_mf) %>% 
  left_join(nc_l) %>% 
  left_join(nc_s) 

#quitar dataset no utilizados
remove(nc_mg, nc_mf, nc_l, nc_s)

nc_mdat %>% 
  select("A√±o"=year,Mes, "No completados"=MDAT_no_completos, "Motor grueso"=incompleto_motor_grueso, "Motor fino"=incompleto_motor_fino, "Lenguaje"=incompleto_lenguaje, "Social"=incompleto_social) %>% 
  kable(caption="<center>Evaluaciones MDAT <br>
        no completadas</center>",align="l") %>% 
  kable_classic(full_width=F, html_font="Cambria")

```


#### Graficas
```{r mdatgraficas}

 mdat %>% 
    select(Mes, month, Realizados, c85_complete) %>% 
    group_by(month, Mes, c85_complete) %>% 
  count() %>% 
  select(month, Mes, Realizados=n, Estado=c85_complete) %>% 
  ggplot(aes(x=Mes, y=Realizados, fill=Estado)) +
    geom_col(position="dodge") + theme_minimal() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  labs(x="Mes",
       y="Realizados",
       title ="Avance mensual MDAT 36m HAPIN 2022") +
  theme(plot.title = element_text(hjust = 0.5)) 

  mdat %>% 
  ungroup() %>% 
    select(week, Realizados, c85_complete) %>% 
    group_by(week, c85_complete) %>% 
  count() %>% 
  select(Week=week, Estado=c85_complete, Realizados=n) %>% 
  ggplot(aes(x=Week, y=Realizados, fill=Estado)) +
    geom_col(position="dodge") + theme_minimal() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +
  labs(x="Week",
       y="Realizados",
       title ="Avance semanal MDAT 36m HAPIN 2022") +
  theme(plot.title = element_text(hjust = 0.5)) 

```


~~~~
 *MDAT al "`r as.Date(f_week2) %>% format(.,"%A %d %B  %Y")` "*
~~~~
